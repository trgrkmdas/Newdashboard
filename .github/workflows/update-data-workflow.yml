name: Odoo Veri GÃ¼ncelleme

on:
  workflow_dispatch:  # Manuel Ã§alÄ±ÅŸtÄ±rma (saÄŸ Ã¼stte "Run workflow" butonu)
    inputs:
      data_scope:
        description: 'Veri kapsamÄ± seÃ§in'
        required: false
        default: 'all_years'
        type: choice
        options:
        - all_years
        - specific_year
      target_year:
        description: 'Hedef yÄ±l (specific_year seÃ§ildiÄŸinde)'
        required: false
        type: string
  schedule:
    - cron: '0 2 * * *'  # Her gece saat 05:00 Ä°stanbul saati (UTC 02:00) - specific_year=2025 Ã§ekiyor

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        persist-credentials: true
    
    - name: Python kurulumu
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Gerekli kÃ¼tÃ¼phaneleri kur
      run: |
        pip install requests
    
    - name: Odoo'dan veri Ã§ek
      env:
        ODOO_URL: ${{ secrets.ODOO_URL }}
        ODOO_USERNAME: ${{ secrets.ODOO_USERNAME }}
        ODOO_API_KEY: ${{ secrets.ODOO_API_KEY }}
        # Otomatik Ã§alÄ±ÅŸma (schedule) iÃ§in: specific_year=2025 (KESIN)
        # Manuel Ã§alÄ±ÅŸma (workflow_dispatch) iÃ§in: kullanÄ±cÄ± seÃ§imi veya all_years
        # NOT: github.event_name kontrolÃ¼ eklendi - schedule trigger iÃ§in kesin olarak specific_year=2025
        DATA_SCOPE: ${{ github.event_name == 'schedule' && 'specific_year' || (github.event.inputs.data_scope || 'all_years') }}
        TARGET_YEAR: ${{ github.event_name == 'schedule' && '2025' || (github.event.inputs.target_year || '2025') }}
      run: |
        python3 << 'EOF'
        import os
        import requests
        import json
        import time
        from datetime import datetime, timedelta
        import warnings
        import xmlrpc.client
        import ssl
        
        warnings.filterwarnings('ignore')
        ssl._create_default_https_context = ssl._create_unverified_context
        
        print("=" * 60)
        print("ğŸš€ Odoo 15 API Test - Yeni KullanÄ±cÄ±")
        print("=" * 60)
        
        url = os.environ['ODOO_URL']
        username = os.environ['ODOO_USERNAME']
        password = os.environ['ODOO_API_KEY']
        db = "erp.zuhalmuzik.com"
        
        print(f"ğŸ”Œ URL: {url}")
        print(f"ğŸ—„ï¸ Database: {db}")
        print(f"ğŸ‘¤ Username: {username}")
        print(f"ğŸ” Password: {'*' * len(password)}")
        # Veri kapsamÄ± kontrolÃ¼ - Otomatik Ã§alÄ±ÅŸma iÃ§in 2025 sabit (KESIN)
        data_scope = os.environ.get('DATA_SCOPE', 'specific_year')  # Otomatik Ã§alÄ±ÅŸma iÃ§in specific_year
        target_year = os.environ.get('TARGET_YEAR', '2025')  # Otomatik Ã§alÄ±ÅŸma iÃ§in 2025 sabit
        
        # GÃœVENLÄ°K KONTROLÃœ: EÄŸer DATA_SCOPE all_years ise ve schedule trigger ise, kesin olarak specific_year=2025 yap
        # Bu ekstra gÃ¼venlik katmanÄ± - GitHub Actions environment variable'larÄ± bazen beklenmedik ÅŸekilde set edilebilir
        print(f"ğŸ” Ä°lk kontrol: DATA_SCOPE={data_scope}, TARGET_YEAR={target_year}")
        if data_scope == 'all_years':
            print(f"âš ï¸ UYARI: DATA_SCOPE='all_years' tespit edildi!")
            print(f"   Bu sadece manuel Ã§alÄ±ÅŸtÄ±rma iÃ§in kullanÄ±lmalÄ±.")
            print(f"   Otomatik Ã§alÄ±ÅŸma (schedule) iÃ§in kesinlikle 'specific_year=2025' olmalÄ±.")
            print(f"   GÃ¼venlik iÃ§in 'specific_year=2025' olarak deÄŸiÅŸtiriliyor...")
            data_scope = 'specific_year'
            target_year = '2025'
            print(f"âœ… GÃ¼venlik dÃ¼zeltmesi: DATA_SCOPE={data_scope}, TARGET_YEAR={target_year}")
        
        if data_scope == 'specific_year':
            if not target_year:
                print("âŒ HATA: specific_year seÃ§ildi ama TARGET_YEAR boÅŸ!")
                exit(1)
            print(f"ğŸ“… Tarih AralÄ±ÄŸÄ±: SADECE {target_year} YILI")
            print(f"ğŸ¯ Hedef YÄ±l: {target_year}")
        else:
            print(f"ğŸ“… Tarih AralÄ±ÄŸÄ±: TÃœM ZAMANLAR (tarih filtresi yok)")
            print(f"ğŸ¯ Hedef: TÃ¼m yÄ±llar")
        
        # Batch boyutu belirleme: 2024/2025 iÃ§in 5,000, diÄŸerleri iÃ§in 22,000
        # NOT: datetime zaten yukarÄ±da import edildi (satÄ±r 54: from datetime import datetime)
        if data_scope == 'specific_year' and target_year in ['2024', '2025']:
            batch_size = 5000
            print(f"ğŸ“¦ Batch Boyutu (2024/2025): {batch_size:,} kayÄ±t/batch (XML parsing hatalarÄ±nÄ± Ã¶nlemek iÃ§in dÃ¼ÅŸÃ¼rÃ¼ldÃ¼)")
        else:
            batch_size = 22000
            print(f"ğŸ“¦ Batch Boyutu: {batch_size:,} kayÄ±t/batch")
        
        try:
            # HTTP Session optimization: Keep-alive ve connection pooling
            from requests.adapters import HTTPAdapter
            from urllib3.util.retry import Retry
            
            session = requests.Session()
            
            # Retry stratejisi (daha hÄ±zlÄ±)
            retry_strategy = Retry(
                total=3,
                backoff_factor=0.5,  # 0.5s, 1s, 2s (daha hÄ±zlÄ±)
                status_forcelist=[500, 502, 503, 504],
                allowed_methods=["POST", "GET"]
            )
            
            # Connection pooling ve keep-alive
            adapter = HTTPAdapter(
                max_retries=retry_strategy,
                pool_connections=10,  # Connection pool
                pool_maxsize=20,
                pool_block=False
            )
            session.mount("http://", adapter)
            session.mount("https://", adapter)
            
            # Gzip compression enable
            session.headers.update({
                'Accept-Encoding': 'gzip, deflate',
                'Connection': 'keep-alive'
            })
            
            # Odoo 15 authenticate
            auth_url = f"{url}/web/session/authenticate"
            
            auth_payload = {
                "jsonrpc": "2.0",
                "method": "call",
                "params": {
                    "db": db,
                    "login": username,
                    "password": password
                },
                "id": 1
            }
            
            print("\nğŸ” Kimlik doÄŸrulama yapÄ±lÄ±yor...")
            
            response = session.post(
                auth_url,
                json=auth_payload,
                headers={"Content-Type": "application/json"},
                verify=False,
                timeout=60
            )
            
            print(f"ğŸ“¡ HTTP Status: {response.status_code}")
            
            if response.status_code != 200:
                print(f"âŒ HTTP HatasÄ±: {response.status_code}")
                print(f"Response: {response.text[:500]}")
                exit(1)
            
            result = response.json()
            
            # Hata kontrolÃ¼
            if 'error' in result:
                error_data = result['error'].get('data', {})
                error_msg = error_data.get('message', result['error'].get('message', 'Bilinmeyen'))
                error_name = error_data.get('name', 'Bilinmeyen')
                
                print(f"âŒ Odoo HatasÄ±: {error_name}")
                print(f"ğŸ“ Mesaj: {error_msg}")
                
                # DetaylÄ± debug
                if 'debug' in error_data:
                    debug = error_data['debug']
                    if 'database' in debug.lower():
                        print("\nğŸ’¡ VERÄ°TABANI HATASI TESPÄ°T EDÄ°LDÄ°!")
                        print("Denenen DB:", db)
                    elif 'access denied' in debug.lower() or 'credentials' in debug.lower():
                        print("\nğŸ’¡ KULLANICI ADI/ÅÄ°FRE HATASI!")
                        print("Username kontrol edin:", username)
                    elif '2fa' in debug.lower() or 'two factor' in debug.lower():
                        print("\nğŸ’¡ 2FA SORUNU!")
                        print("KullanÄ±cÄ±da 2FA kapalÄ± mÄ± kontrol edin")
                
                exit(1)
            
            # BaÅŸarÄ±lÄ± giriÅŸ
            if 'result' in result:
                session_info = result['result']
                
                if session_info and isinstance(session_info, dict):
                    uid = session_info.get('uid')
                    
                    if uid:
                        print("\n" + "=" * 60)
                        print("âœ… BAÅARILI! ODOO'YA BAÄLANILDI!")
                        print("=" * 60)
                        print(f"ğŸ‘¤ User ID: {uid}")
                        print(f"ğŸ‘¤ Ä°sim: {session_info.get('name', 'N/A')}")
                        print(f"ğŸ¢ Åirket: {session_info.get('company_name', 'N/A')}")
                        print(f"ğŸ—„ï¸ GerÃ§ek DB: {session_info.get('db', 'N/A')}")
                        print(f"ğŸŒ User Context: {session_info.get('user_context', {})}")
                        
                        # Veri Ã§ekme testi
                        print("\n" + "=" * 60)
                        print("ğŸ‰ GÄ°RÄ°Å BAÅARILI! XML-RPC Ä°LE VERÄ° Ã‡EKMEYE GEÃ‡Ä°YORUZ")
                        print("=" * 60)
                        
                        # XML-RPC ile devam et (daha stabil)
                        print("\nğŸ”„ XML-RPC baÄŸlantÄ±sÄ± kuruluyor...")
                        
                        try:
                            common = xmlrpc.client.ServerProxy(f'{url}/xmlrpc/2/common')
                            models = xmlrpc.client.ServerProxy(f'{url}/xmlrpc/2/object')
                            
                            # Tekrar authenticate (XML-RPC iÃ§in)
                            uid_xmlrpc = common.authenticate(db, username, password, {})
                            
                            if not uid_xmlrpc:
                                print("âŒ XML-RPC authentication baÅŸarÄ±sÄ±z!")
                                exit(1)
                            
                            print(f"âœ… XML-RPC baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±! (UID: {uid_xmlrpc})")
                        except Exception as e:
                            print(f"âŒ XML-RPC hatasÄ±: {e}")
                            print("âš ï¸ REST API ile devam ediliyor...")
                            models = None
                        
                        # KAPSAMLI VERÄ° Ã‡EKME BAÅLIYOR
                        print("\n" + "=" * 60)
                        print("ğŸ“Š KAPSAMLI VERÄ° Ã‡EKME BAÅLADI")
                        print("=" * 60)
                        
                        # XML-RPC Ä°LE VERÄ° Ã‡EK
                        print("\n1ï¸âƒ£ ALL ZUHAL filtresi ile fatura satÄ±rlarÄ± Ã§ekiliyor (XML-RPC)...")
                        
                        if models:
                            # XML-RPC ile Ã§ek
                            try:
                                print("â³ Veri Ã§ekiliyor (bu 2-3 dakika sÃ¼rebilir)...")
                                
                                # ALL ZUHAL FÄ°LTRESÄ° - KullanÄ±cÄ±nÄ±n kaydedilmiÅŸ filtresini Ã§ek
                                print("ğŸ” 'ALL ZUHAL' filtresinin domain'i Ã§ekiliyor...")
                                
                                try:
                                    # SADECE 'ALL ZUHAL' FÄ°LTRESÄ°NÄ° ARA (TEK YER)
                                    print("ğŸ” 'ALL ZUHAL' filtresi aranÄ±yor...")
                                    
                                    filters = models.execute_kw(
                                        db, uid_xmlrpc, password,
                                        'ir.filters', 'search_read',
                                        [[
                                            ('user_id', '=', uid_xmlrpc),
                                            ('model_id', '=', 'account.invoice.report'),
                                            ('name', '=', 'ALL ZUHAL')
                                        ]],
                                        {'fields': ['name', 'domain', 'context']}
                                    )
                                    
                                    # Filtre bulunamadÄ±ysa HATA VER VE DURDUR
                                    if not filters or len(filters) == 0:
                                        print("âŒ HATA: 'ALL ZUHAL' filtresi bulunamadÄ±!")
                                        print("âŒ KullanÄ±cÄ±ya Ã¶zel account.invoice.report'ta 'ALL ZUHAL' filtresi olmalÄ±.")
                                        exit(1)
                                    
                                    # Filtre bulundu
                                    filter_data = filters[0]
                                    print(f"âœ… 'ALL ZUHAL' filtresi bulundu!")
                                    print(f"ğŸ“‹ Domain: {filter_data['domain']}")
                                    
                                    # KONTROL: Filtre out_refund'larÄ± dahil ediyor mu?
                                    if 'out_refund' in str(filter_data['domain']):
                                        print("âš ï¸ DÄ°KKAT: Filtre domain'inde 'out_refund' bulundu!")
                                    else:
                                        print("âš ï¸ UYARI: Filtre domain'inde 'out_refund' YOK - Ä°adeler filtrede hariÃ§ tutulmuÅŸ olabilir!")
                                    
                                    # Domain'i parse et
                                    import ast
                                    domain = ast.literal_eval(filter_data['domain']) if filter_data['domain'] else []
                                    
                                    if not domain:
                                        print("âŒ HATA: Filtre domain'i boÅŸ!")
                                        exit(1)
                                    
                                    # Domain'i account.move.line formatÄ±na Ã§evir
                                    print("ğŸ”„ Domain account.move.line formatÄ±na Ã§evriliyor...")
                                    converted_domain = []
                                    has_move_type_filter = False
                                    
                                    for item in domain:
                                        if isinstance(item, tuple) and len(item) >= 3:
                                            field, operator, value = item[0], item[1], item[2]
                                            # Alan adlarÄ±nÄ± dÃ¶nÃ¼ÅŸtÃ¼r
                                            if field == 'state':
                                                # account.move.line'da state alanÄ± yok, atla
                                                continue
                                            elif field == 'move_type':
                                                field = 'move_id.move_type'
                                                has_move_type_filter = True
                                                # Ã–NEMLÄ°: move_type filtresini out_invoice VE out_refund iÃ§erecek ÅŸekilde deÄŸiÅŸtir
                                                if operator == '=' and value == 'out_invoice':
                                                    # Sadece out_invoice varsa, out_refund'u da ekle
                                                    operator = 'in'
                                                    value = ('out_invoice', 'out_refund')
                                                    print("ğŸ”§ move_type filtresi gÃ¼ncellendi: out_invoice + out_refund dahil")
                                                elif operator == 'in' and isinstance(value, (list, tuple)):
                                                    # EÄŸer liste varsa ve out_refund yoksa ekle
                                                    value_list = list(value)
                                                    if 'out_invoice' in value_list and 'out_refund' not in value_list:
                                                        value_list.append('out_refund')
                                                        value = tuple(value_list)
                                                        print("ğŸ”§ move_type filtresine out_refund eklendi")
                                            elif field == 'analytic_account_id':
                                                field = 'analytic_account_id'
                                            elif field == 'product_categ_id':
                                                field = 'product_id.categ_id'
                                            elif field == 'product_id':
                                                field = 'product_id'
                                            converted_domain.append((field, operator, value))
                                        else:
                                            converted_domain.append(item)
                                    
                                    # EÄŸer move_type filtresi yoksa ekle (hem out_invoice hem out_refund)
                                    if not has_move_type_filter:
                                        converted_domain.append(('move_id.move_type', 'in', ('out_invoice', 'out_refund')))
                                        print("â• move_type filtresi eklendi: out_invoice + out_refund")
                                    
                                    # display_type ekle
                                    converted_domain.append(('display_type', '=', False))
                                    
                                    # Ã–NEMLÄ°: SADECE POSTED (OnaylanmÄ±ÅŸ) FATURALARI Ã‡EK
                                    # Taslak (draft) ve iptal (cancel) faturalarÄ± HARÄ°Ã‡ TUT
                                    converted_domain.append(('move_id.state', '=', 'posted'))
                                    print("ğŸ”’ State filtresi eklendi: SADECE posted (onaylanmÄ±ÅŸ) faturalar")
                                    
                                    # YIL FÄ°LTRESÄ° EKLE
                                    if data_scope == 'specific_year':
                                        print(f"ğŸ“… SADECE {target_year} YILI Ã§ekiliyor!")
                                        # Tarih filtresi ekle
                                        converted_domain.append(('date', '>=', f'{target_year}-01-01'))
                                        converted_domain.append(('date', '<=', f'{target_year}-12-31'))
                                    else:
                                        print("ğŸ“… TÃœM ZAMANLAR Ã§ekiliyor!")
                                    
                                    domain = converted_domain
                                    print(f"âœ… Domain dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼: {len(domain)} koÅŸul")
                                    
                                    # DOÄRULAMA: move_type ve state filtrelerinin varlÄ±ÄŸÄ±nÄ± kontrol et
                                    move_type_found = False
                                    posted_state_found = False
                                    for item in domain:
                                        if isinstance(item, tuple) and len(item) >= 3:
                                            field, operator, value = item[0], item[1], item[2]
                                            if field == 'move_id.move_type':
                                                move_type_found = True
                                                print(f"âœ… DOÄRULAMA: move_type filtresi bulundu: {operator} {value}")
                                                if isinstance(value, (list, tuple)):
                                                    if 'out_invoice' in value and 'out_refund' in value:
                                                        print(f"   âœ… Sadece out_invoice ve out_refund Ã§ekilecek (doÄŸru)")
                                                    else:
                                                        print(f"   âš ï¸ UYARI: move_type deÄŸerleri beklenen deÄŸil: {value}")
                                            elif field == 'move_id.state':
                                                posted_state_found = True
                                                if operator == '=' and value == 'posted':
                                                    print(f"âœ… DOÄRULAMA: State filtresi bulundu: SADECE posted (onaylanmÄ±ÅŸ) faturalar")
                                                else:
                                                    print(f"   âš ï¸ UYARI: State filtresi beklenen deÄŸil: {operator} {value}")
                                    
                                    if not move_type_found:
                                        print("âŒ UYARI: move_type filtresi bulunamadÄ±!")
                                    if not posted_state_found:
                                        print("âŒ UYARI: move_id.state filtresi bulunamadÄ±!")
                                    
                                    # Final domain'i logla (debug iÃ§in)
                                    print(f"ğŸ“‹ FINAL DOMAIN ({len(domain)} koÅŸul):")
                                    for idx, item in enumerate(domain, 1):
                                        if isinstance(item, tuple) and len(item) >= 3:
                                            print(f"   {idx}. {item[0]} {item[1]} {item[2]}")
                                        else:
                                            print(f"   {idx}. {item}")
                                    
                                except Exception as e:
                                    print(f"âŒ HATA: Filtre Ã§ekme hatasÄ±: {e}")
                                    import traceback
                                    traceback.print_exc()
                                    exit(1)
                                
                                # KayÄ±t sayÄ±sÄ±nÄ± kontrol et (account.move.line) - 2023 iÃ§in Ã§ok yavaÅŸ, atla
                                print("ğŸ“Š KayÄ±t sayÄ±sÄ± kontrolÃ¼ atlanÄ±yor (2023 iÃ§in Ã§ok yavaÅŸ)...")
                                
                                # account.move.line alanlarÄ±
                                fields = [
                                    'move_id', 'date', 'create_date', 'write_date',
                                    'product_id', 'quantity', 'price_subtotal', 
                                    'currency_id', 'partner_id', 'analytic_account_id', 'id'
                                ]
                                
                                # Ã–ZEL BATCH STRATEJÄ°SÄ° Ä°LE VERÄ° Ã‡EKME
                                print("ğŸ¯ Ã–zel batch stratejisi ile veri Ã§ekiliyor...")
                                
                                # YÄ±la gÃ¶re batch stratejisi belirleme
                                # all_years iÃ§in tÃ¼m yÄ±llarÄ± birleÅŸtir, specific_year iÃ§in tek yÄ±l
                                all_data = []
                                all_years_combined_data = []  # all_years iÃ§in tÃ¼m yÄ±llarÄ± tutmak iÃ§in
                                
                                # all_years durumunda yÄ±llarÄ± ayrÄ± ayrÄ± iÅŸle
                                if data_scope == 'all_years':
                                    print("ğŸ“… TÃœM YILLAR Ã§ekilecek (her yÄ±l iÃ§in Ã¶zel batch stratejisi):")
                                    years_to_process = ['2023', '2024', '2025']
                                    for processing_year in years_to_process:
                                        print(f"\n{'='*60}")
                                        print(f"ğŸ—“ï¸ {processing_year} YILI Ä°ÅLENÄ°YOR")
                                        print(f"{'='*60}")
                                        
                                        # Her yÄ±l iÃ§in all_data'yÄ± temizle
                                        all_data = []
                                        
                                        # YÄ±l iÃ§in domain oluÅŸtur
                                        year_domain = domain + [
                                            ('date', '>=', f'{processing_year}-01-01'),
                                            ('date', '<=', f'{processing_year}-12-31')
                                        ]
                                        
                                        # 2023 iÃ§in Ã¶zel mantÄ±k
                                        if processing_year == '2023':
                                            print("ğŸ—“ï¸ 2023 yÄ±lÄ± Ã§ekilecek:")
                                            print("   - AralÄ±k: GÃœNLÃœK batch stratejisi (problematik gÃ¼nleri izole etmek iÃ§in)")
                                            print("   - DiÄŸer aylar: AylÄ±k batch stratejisi (2500 batch size)")
                                            month_days = {
                                                '01': 31, '02': 28, '03': 31, '04': 30,
                                                '05': 31, '06': 30, '07': 31, '08': 31,
                                                '09': 30, '10': 31, '11': 30, '12': 31
                                            }
                                            for mm in [f"{i:02d}" for i in range(1, 13)]:
                                                month_start = f"{processing_year}-{mm}-01"
                                                month_end = f"{processing_year}-{mm}-{month_days[mm]}"
                                        
                                                # AralÄ±k iÃ§in GÃœNLÃœK strateji, diÄŸerleri iÃ§in AYLIK strateji
                                                if mm == '12':
                                                    print(f"\nğŸ“… {mm}/{processing_year} GÃœNLÃœK Ã§ekiliyor (problematik gÃ¼nleri izole etmek iÃ§in)...")
                                                    current_date = datetime.strptime(month_start, '%Y-%m-%d')
                                                    month_end_dt = datetime.strptime(month_end, '%Y-%m-%d')
                                                    skipped_days = []
                                                    
                                                    while current_date <= month_end_dt:
                                                        day_str = current_date.strftime('%Y-%m-%d')
                                                        day_domain = year_domain + [('date', '=', day_str)]
                                                        current_batch_size = 250
                                                        print(f"   ğŸ“† {day_str} Ã§ekiliyor...")
                                                        offset = 0
                                                        batch_count = 0
                                                        day_success = False
                                                        
                                                        problematic_records_skipped = 0
                                                        max_problematic_records = 50  # GÃ¼n iÃ§inde 50'den fazla sorunlu kayÄ±t varsa gÃ¼nÃ¼ atla
                                                        
                                                        while True:
                                                            batch_count += 1
                                                            retry_count = 0
                                                            batch_data = []
                                                            original_batch_size = current_batch_size
                                                            
                                                            while retry_count < 5:  # XML parsing iÃ§in daha fazla deneme
                                                                try:
                                                                    safe_fields = [
                                                                        'move_id', 'date', 'create_date', 'write_date',
                                                                        'product_id', 'quantity', 'price_subtotal',
                                                                        'currency_id', 'partner_id', 'analytic_account_id', 'id',
                                                                    ]
                                                                    batch_data = models.execute_kw(
                                                                        db, uid_xmlrpc, password,
                                                                        'account.move.line', 'search_read',
                                                                        [day_domain],
                                                                        {'fields': safe_fields, 'limit': current_batch_size, 'offset': offset}
                                                                    )
                                                                    break
                                                                except Exception as retry_error:
                                                                    retry_count += 1
                                                                    error_msg = str(retry_error)[:200]
                                                                    
                                                                    # 500 Internal Server Error iÃ§in exponential backoff
                                                                    if "500 Internal Server Error" in str(retry_error):
                                                                        wait_time = min(3 * (2 ** retry_count), 30)  # 3s, 6s, 12s, 24s, 30s
                                                                        print(f"   âš ï¸ {day_str} Batch {batch_count} Retry {retry_count}/5: 500 Server Error - {wait_time}s bekleniyor...")
                                                                        time.sleep(wait_time)
                                                                        if retry_count >= 5:
                                                                            print(f"   âŒ {day_str}: 500 hatasÄ± tÃ¼m denemeler baÅŸarÄ±sÄ±z, gÃ¼n atlanÄ±yor...")
                                                                            skipped_days.append(day_str)
                                                                            break
                                                                        continue
                                                                    
                                                                    # XML parsing hatasÄ± iÃ§in agresif kÃ¼Ã§Ã¼ltme
                                                                    if "not well-formed" in error_msg or "invalid token" in error_msg:
                                                                        print(f"   ğŸ”§ {day_str} XML parsing hatasÄ± (line/column belirtili): batch boyutu kÃ¼Ã§Ã¼ltÃ¼lÃ¼yor...")
                                                                        if current_batch_size > 1:
                                                                            current_batch_size = max(1, current_batch_size // 4)  # 1/4'e indir (250â†’62â†’15â†’3â†’1)
                                                                        else:
                                                                            # Batch 1'de bile hata varsa, bu kaydÄ± atla ve diÄŸerlerini Ã§ekmeye devam et
                                                                            problematic_records_skipped += 1
                                                                            print(f"   âš ï¸ {day_str}: Sorunlu kayÄ±t #{problematic_records_skipped} atlanÄ±yor (offset: {offset})...")
                                                                            offset += 1
                                                                            current_batch_size = original_batch_size  # Reset
                                                                            
                                                                            # Ã‡ok fazla sorunlu kayÄ±t varsa gÃ¼nÃ¼ atla
                                                                            if problematic_records_skipped >= max_problematic_records:
                                                                                print(f"   âŒ {day_str}: {problematic_records_skipped} sorunlu kayÄ±t bulundu, gÃ¼n atlanÄ±yor...")
                                                                                skipped_days.append(day_str)
                                                                                break
                                                                            
                                                                            # Retry'yi sÄ±fÄ±rla ve devam et
                                                                            retry_count = 0
                                                                            continue
                                                                        print(f"   ğŸ“¦ Yeni batch boyutu: {current_batch_size}")
                                                                    
                                                                    if retry_count >= 5:
                                                                        # Sadece 500 hatasÄ± deÄŸilse, kaydÄ± atla
                                                                        if "500 Internal Server Error" not in str(retry_error):
                                                                            problematic_records_skipped += 1
                                                                            print(f"   âš ï¸ {day_str}: Sorunlu kayÄ±t #{problematic_records_skipped} atlanÄ±yor (offset: {offset}, retry baÅŸarÄ±sÄ±z)...")
                                                                            offset += 1
                                                                            current_batch_size = original_batch_size
                                                                            if problematic_records_skipped >= max_problematic_records:
                                                                                print(f"   âŒ {day_str}: {problematic_records_skipped} sorunlu kayÄ±t bulundu, gÃ¼n atlanÄ±yor...")
                                                                                skipped_days.append(day_str)
                                                                                break
                                                                            retry_count = 0
                                                                            continue
                                                                        else:
                                                                            print(f"   âŒ {day_str} Batch {batch_count}: TÃ¼m denemeler baÅŸarÄ±sÄ±z...")
                                                                            skipped_days.append(day_str)
                                                                            break
                                                                    time.sleep(2)
                                                            
                                                            if not batch_data or len(batch_data) == 0:
                                                                if day_str not in skipped_days:
                                                                    day_success = True
                                                                break
                                                            
                                                            if day_str in skipped_days:
                                                                break
                                                            
                                                            try:
                                                                # Duplicate kontrolÃ¼ kaldÄ±rÄ±ldÄ± - direkt ekle
                                                                if batch_data:
                                                                    all_data.extend(batch_data)
                                                                if len(batch_data) < current_batch_size:
                                                                    day_success = True
                                                                    break
                                                                offset += current_batch_size
                                                                current_batch_size = original_batch_size  # Reset batch size
                                                            except Exception as e:
                                                                print(f"   âŒ {day_str} Veri iÅŸleme hatasÄ±: {str(e)[:200]}")
                                                                offset += current_batch_size
                                                                continue
                                                        
                                                        if day_success:
                                                            print(f"   âœ… {day_str} tamamlandÄ±!")
                                                        
                                                        current_date += timedelta(days=1)
                                                    
                                                    if skipped_days:
                                                        print(f"   âš ï¸ Atlanan gÃ¼nler: {', '.join(skipped_days)}")
                                                
                                                else:
                                                    # DiÄŸer aylar: Normal aylÄ±k strateji
                                                    month_domain = year_domain + [('date', '>=', month_start), ('date', '<=', month_end)]
                                                    current_batch_size = 2500
                                                    print(f"\nğŸ“¦ {mm}/{processing_year} Ã§ekiliyor | BatchSize={current_batch_size}")
                                                    offset = 0
                                                    batch_count = 0
                                                    max_errors = 5
                                                    error_count = 0
                                                    max_retries = 5  # ArtÄ±rÄ±ldÄ±
                                                    
                                                    while True:
                                                        batch_count += 1
                                                        if batch_count % 50 == 1:
                                                            print(f"ğŸ“¦ Batch {batch_count}: Offset {offset:,} - {offset + current_batch_size:,} (Size: {current_batch_size})")
                                                        retry_count = 0
                                                        batch_data = []
                                                        original_batch_size = current_batch_size
                                                        
                                                        while retry_count < max_retries:
                                                            try:
                                                                safe_fields = [
                                                                    'move_id', 'date', 'create_date', 'write_date',
                                                                    'product_id', 'quantity', 'price_subtotal',
                                                                    'currency_id', 'partner_id', 'analytic_account_id', 'id',
                                                                ]
                                                                batch_data = models.execute_kw(
                                                                    db, uid_xmlrpc, password,
                                                                    'account.move.line', 'search_read',
                                                                    [month_domain],
                                                                    {'fields': safe_fields, 'limit': current_batch_size, 'offset': offset}
                                                                )
                                                                break
                                                            except Exception as retry_error:
                                                                retry_count += 1
                                                                error_msg = str(retry_error)[:200]
                                                                print(f"âš ï¸ Batch {batch_count} Retry {retry_count}/{max_retries}: {error_msg}")
                                                                
                                                                # 500 Internal Server Error iÃ§in exponential backoff
                                                                if "500 Internal Server Error" in str(retry_error):
                                                                    wait_time = min(3 * (2 ** retry_count), 30)
                                                                    print(f"ğŸ”„ 500 Server Error - {wait_time}s bekleniyor...")
                                                                    time.sleep(wait_time)
                                                                    if retry_count >= max_retries:
                                                                        print("âŒ Batch tÃ¼m denemeler baÅŸarÄ±sÄ±z, atlanÄ±yor...")
                                                                        break
                                                                    continue
                                                                
                                                                # XML parsing hatasÄ± iÃ§in agresif kÃ¼Ã§Ã¼ltme
                                                                if "not well-formed" in error_msg or "invalid token" in error_msg:
                                                                    print("ğŸ”§ XML parsing hatasÄ±: batch boyutu agresif kÃ¼Ã§Ã¼ltÃ¼lÃ¼yor...")
                                                                    current_batch_size = max(1, current_batch_size // 4)  # 1/4'e indir
                                                                    print(f"ğŸ“¦ Yeni batch boyutu: {current_batch_size}")
                                                                
                                                                if retry_count >= max_retries:
                                                                    print("âŒ Batch tÃ¼m denemeler baÅŸarÄ±sÄ±z, atlanÄ±yor...")
                                                                    break
                                                                time.sleep(3)
                                                        
                                                        if not batch_data or len(batch_data) == 0:
                                                            print("âœ… Ay iÃ§i veri bitti!")
                                                            break
                                                        
                                                        try:
                                                            # Duplicate kontrolÃ¼ kaldÄ±rÄ±ldÄ± - direkt ekle
                                                            if batch_data:
                                                                all_data.extend(batch_data)
                                                                error_count = 0
                                                            current_batch_size = original_batch_size  # Reset
                                                            if len(batch_data) < current_batch_size:
                                                                print("âœ… Ay son batch tamamlandÄ±!")
                                                                break
                                                            offset += current_batch_size
                                                        except Exception as e:
                                                            error_count += 1
                                                            print(f"âŒ Batch HATASI: {str(e)[:200]}")
                                                            print(f"ğŸ” Hata detayÄ±: Month={mm}, BatchSize={current_batch_size}, Offset={offset}")
                                                            if error_count >= max_errors:
                                                                print("âŒ Ã‡ok fazla hata, ay dÃ¶ngÃ¼sÃ¼ durduruluyor...")
                                                                break
                                                            time.sleep(5)
                                                            offset += current_batch_size
                                                            continue
                                            
                                            year_data_count = len([d for d in all_data if d.get('date', '')[:4] == processing_year])
                                            print(f"âœ… {processing_year} yÄ±lÄ± tamamlandÄ±: {year_data_count} kayÄ±t")
                                            
                                            # YÄ±l verilerini combined list'e ekle (duplicate kontrolÃ¼ kaldÄ±rÄ±ldÄ±)
                                            all_years_combined_data.extend(all_data)
                                        
                                        # 2024/2025 iÃ§in 5,000 batch size
                                        elif processing_year in ['2024', '2025']:
                                            print(f"ğŸ“¦ {processing_year} yÄ±lÄ± Ã§ekiliyor (BatchSize=5,000)...")
                                            offset = 0
                                            batch_count = 0
                                            max_errors = 5
                                            error_count = 0
                                            max_retries = 5
                                            current_batch_size = 5000
                                            original_batch_size = 5000
                                            
                                            while True:
                                                batch_count += 1
                                                if batch_count % 50 == 1:
                                                    print(f"ğŸ“¦ Batch {batch_count}: Offset {offset:,} - {offset + current_batch_size:,} (Size: {current_batch_size})")
                                                retry_count = 0
                                                batch_data = []
                                                
                                                while retry_count < max_retries:
                                                    try:
                                                        safe_fields = [
                                                            'move_id', 'date', 'create_date', 'write_date',
                                                            'product_id', 'quantity', 'price_subtotal',
                                                            'currency_id', 'partner_id', 'analytic_account_id', 'id',
                                                        ]
                                                        batch_data = models.execute_kw(
                                                            db, uid_xmlrpc, password,
                                                            'account.move.line', 'search_read',
                                                            [year_domain],
                                                            {'fields': safe_fields, 'limit': current_batch_size, 'offset': offset}
                                                        )
                                                        break
                                                    except Exception as retry_error:
                                                        retry_count += 1
                                                        error_msg = str(retry_error)[:200]
                                                        print(f"âš ï¸ Batch {batch_count} Retry {retry_count}/{max_retries}: {error_msg}")
                                                        
                                                        # 500 Internal Server Error iÃ§in exponential backoff
                                                        if "500 Internal Server Error" in str(retry_error):
                                                            wait_time = min(3 * (2 ** retry_count), 30)
                                                            print(f"ğŸ”„ 500 Server Error - {wait_time}s bekleniyor...")
                                                            time.sleep(wait_time)
                                                            if retry_count >= max_retries:
                                                                print(f"âŒ Batch {batch_count} tÃ¼m denemeler baÅŸarÄ±sÄ±z, atlanÄ±yor...")
                                                                break
                                                            continue
                                                        
                                                        # XML parsing hatasÄ± iÃ§in agresif kÃ¼Ã§Ã¼ltme
                                                        if "not well-formed" in error_msg or "invalid token" in error_msg:
                                                            print(f"ğŸ”§ XML parsing hatasÄ± tespit edildi, batch boyutu agresif kÃ¼Ã§Ã¼ltÃ¼lÃ¼yor...")
                                                            current_batch_size = max(1, current_batch_size // 4)  # 1/4'e indir
                                                            print(f"ğŸ“¦ Yeni batch boyutu: {current_batch_size}")
                                                        
                                                        if retry_count >= max_retries:
                                                            print(f"âŒ Batch {batch_count} tÃ¼m denemeler baÅŸarÄ±sÄ±z, atlanÄ±yor...")
                                                            break
                                                        time.sleep(3)
                                                
                                                if not batch_data or len(batch_data) == 0:
                                                    print(f"âœ… {processing_year} yÄ±lÄ± veri bitti!")
                                                    break
                                                
                                                try:
                                                    # Duplicate kontrolÃ¼ kaldÄ±rÄ±ldÄ± - direkt ekle
                                                    if batch_data:
                                                        all_data.extend(batch_data)
                                                    error_count = 0
                                                    current_batch_size = original_batch_size  # Reset batch size
                                                    if len(batch_data) < current_batch_size:
                                                        print(f"âœ… {processing_year} yÄ±lÄ± son batch tamamlandÄ±! (Toplam: {len(all_data)} kayÄ±t)")
                                                        break
                                                    offset += current_batch_size
                                                except Exception as e:
                                                    error_count += 1
                                                    print(f"âŒ Batch {batch_count} HATASI: {str(e)[:200]}")
                                                    print(f"ğŸ” Hata detayÄ±: Year={processing_year}, BatchSize={current_batch_size}, Offset={offset}")
                                                    if error_count >= max_errors:
                                                        print(f"âŒ Ã‡ok fazla hata ({max_errors}), {processing_year} yÄ±lÄ± durduruluyor...")
                                                        break
                                                    time.sleep(5)
                                                    offset += current_batch_size
                                                    continue
                                            
                                            year_data_count = len([d for d in all_data if d.get('date', '')[:4] == processing_year])
                                            print(f"âœ… {processing_year} yÄ±lÄ± tamamlandÄ±: {year_data_count} kayÄ±t")
                                            
                                            # YÄ±l verilerini combined list'e ekle (duplicate kontrolÃ¼ kaldÄ±rÄ±ldÄ±)
                                            all_years_combined_data.extend(all_data)
                                
                                # all_years iÃ§in combined_data'yÄ± kullan
                                if data_scope == 'all_years':
                                    print(f"\nğŸ“Š TÃœM YILLAR birleÅŸtirildi: {len(all_years_combined_data)} unique kayÄ±t")
                                    all_data = all_years_combined_data
                                
                                # specific_year durumunda (mevcut mantÄ±k)
                                elif data_scope == 'specific_year' and target_year == '2023':
                                    print("ğŸ—“ï¸ 2023 yÄ±lÄ± Ã§ekilecek:")
                                    print("   - AralÄ±k: GÃœNLÃœK batch stratejisi (problematik gÃ¼nleri izole etmek iÃ§in)")
                                    print("   - DiÄŸer aylar: AylÄ±k batch stratejisi (2500 batch size)")
                                    month_days = {
                                        '01': 31, '02': 28, '03': 31, '04': 30,
                                        '05': 31, '06': 30, '07': 31, '08': 31,
                                        '09': 30, '10': 31, '11': 30, '12': 31
                                    }
                                    for mm in [f"{i:02d}" for i in range(1, 13)]:
                                        month_start = f"{target_year}-{mm}-01"
                                        month_end = f"{target_year}-{mm}-{month_days[mm]}"
                                        
                                        # AralÄ±k iÃ§in GÃœNLÃœK strateji, diÄŸerleri iÃ§in AYLIK strateji
                                        if mm == '12':
                                            print(f"\nğŸ“… {mm}/{target_year} GÃœNLÃœK Ã§ekiliyor (problematik gÃ¼nleri izole etmek iÃ§in)...")
                                            current_date = datetime.strptime(month_start, '%Y-%m-%d')
                                            month_end_dt = datetime.strptime(month_end, '%Y-%m-%d')
                                            skipped_days = []
                                            
                                            while current_date <= month_end_dt:
                                                day_str = current_date.strftime('%Y-%m-%d')
                                                day_domain = domain + [('date', '=', day_str)]
                                                current_batch_size = 250
                                                print(f"   ğŸ“† {day_str} Ã§ekiliyor...")
                                                offset = 0
                                                batch_count = 0
                                                day_success = False
                                                problematic_records_skipped = 0
                                                max_problematic_records = 50  # GÃ¼n iÃ§inde 50'den fazla sorunlu kayÄ±t varsa gÃ¼nÃ¼ atla
                                                
                                                while True:
                                                    batch_count += 1
                                                    retry_count = 0
                                                    batch_data = []
                                                    original_batch_size = current_batch_size
                                                    
                                                    while retry_count < 5:  # XML parsing iÃ§in daha fazla deneme
                                                        try:
                                                            safe_fields = [
                                                                'move_id', 'date', 'create_date', 'write_date',
                                                                'product_id', 'quantity', 'price_subtotal',
                                                                'currency_id', 'partner_id', 'analytic_account_id', 'id'
                                                            ]
                                                            batch_data = models.execute_kw(
                                                                db, uid_xmlrpc, password,
                                                                'account.move.line', 'search_read',
                                                                [day_domain],
                                                                {'fields': safe_fields, 'limit': current_batch_size, 'offset': offset}
                                                            )
                                                            break
                                                        except Exception as retry_error:
                                                            retry_count += 1
                                                            error_msg = str(retry_error)[:200]
                                                            
                                                            # 500 Internal Server Error iÃ§in exponential backoff
                                                            if "500 Internal Server Error" in str(retry_error):
                                                                wait_time = min(3 * (2 ** retry_count), 30)  # 3s, 6s, 12s, 24s, 30s
                                                                print(f"   âš ï¸ {day_str} Batch {batch_count} Retry {retry_count}/5: 500 Server Error - {wait_time}s bekleniyor...")
                                                                time.sleep(wait_time)
                                                                if retry_count >= 5:
                                                                    print(f"   âŒ {day_str}: 500 hatasÄ± tÃ¼m denemeler baÅŸarÄ±sÄ±z, gÃ¼n atlanÄ±yor...")
                                                                    skipped_days.append(day_str)
                                                                    break
                                                                continue
                                                            
                                                            # XML parsing hatasÄ± iÃ§in agresif kÃ¼Ã§Ã¼ltme
                                                            if "not well-formed" in error_msg or "invalid token" in error_msg:
                                                                print(f"   ğŸ”§ {day_str} XML parsing hatasÄ± (line/column belirtili): batch boyutu kÃ¼Ã§Ã¼ltÃ¼lÃ¼yor...")
                                                                if current_batch_size > 1:
                                                                    current_batch_size = max(1, current_batch_size // 4)  # 1/4'e indir (250â†’62â†’15â†’3â†’1)
                                                                else:
                                                                    # Batch 1'de bile hata varsa, bu kaydÄ± atla ve diÄŸerlerini Ã§ekmeye devam et
                                                                    problematic_records_skipped += 1
                                                                    print(f"   âš ï¸ {day_str}: Sorunlu kayÄ±t #{problematic_records_skipped} atlanÄ±yor (offset: {offset})...")
                                                                    offset += 1
                                                                    current_batch_size = original_batch_size  # Reset
                                                                    
                                                                    # Ã‡ok fazla sorunlu kayÄ±t varsa gÃ¼nÃ¼ atla
                                                                    if problematic_records_skipped >= max_problematic_records:
                                                                        print(f"   âŒ {day_str}: {problematic_records_skipped} sorunlu kayÄ±t bulundu, gÃ¼n atlanÄ±yor...")
                                                                        skipped_days.append(day_str)
                                                                        break
                                                                    
                                                                    # Retry'yi sÄ±fÄ±rla ve devam et
                                                                    retry_count = 0
                                                                    continue
                                                                print(f"   ğŸ“¦ Yeni batch boyutu: {current_batch_size}")
                                                            
                                                            if retry_count >= 5:
                                                                # Sadece 500 hatasÄ± deÄŸilse, kaydÄ± atla
                                                                if "500 Internal Server Error" not in str(retry_error):
                                                                    problematic_records_skipped += 1
                                                                    print(f"   âš ï¸ {day_str}: Sorunlu kayÄ±t #{problematic_records_skipped} atlanÄ±yor (offset: {offset}, retry baÅŸarÄ±sÄ±z)...")
                                                                    offset += 1
                                                                    current_batch_size = original_batch_size
                                                                    if problematic_records_skipped >= max_problematic_records:
                                                                        print(f"   âŒ {day_str}: {problematic_records_skipped} sorunlu kayÄ±t bulundu, gÃ¼n atlanÄ±yor...")
                                                                        skipped_days.append(day_str)
                                                                        break
                                                                    retry_count = 0
                                                                    continue
                                                                else:
                                                                    print(f"   âŒ {day_str} Batch {batch_count}: TÃ¼m denemeler baÅŸarÄ±sÄ±z...")
                                                                    skipped_days.append(day_str)
                                                                    break
                                                            time.sleep(2)
                                                    
                                                    if not batch_data or len(batch_data) == 0:
                                                        if day_str not in skipped_days:
                                                            day_success = True
                                                        break
                                                    
                                                    if day_str in skipped_days:
                                                        break
                                                    
                                                    try:
                                                        # Duplicate kontrolÃ¼ kaldÄ±rÄ±ldÄ± - direkt ekle
                                                        if batch_data:
                                                            all_data.extend(batch_data)
                                                        if len(batch_data) < current_batch_size:
                                                            day_success = True
                                                            break
                                                        offset += current_batch_size
                                                        current_batch_size = original_batch_size  # Reset batch size
                                                    except Exception as e:
                                                        print(f"   âŒ {day_str} Veri iÅŸleme hatasÄ±: {str(e)[:200]}")
                                                        offset += current_batch_size
                                                        continue
                                                
                                                if day_success:
                                                    print(f"   âœ… {day_str} tamamlandÄ±!")
                                                
                                                current_date += timedelta(days=1)
                                            
                                            if skipped_days:
                                                print(f"   âš ï¸ Atlanan gÃ¼nler: {', '.join(skipped_days)}")
                                        
                                        else:
                                            # DiÄŸer aylar: Normal aylÄ±k strateji
                                            month_domain = domain + [('date', '>=', month_start), ('date', '<=', month_end)]
                                            current_batch_size = 2500
                                            print(f"\nğŸ“¦ {mm}/{target_year} Ã§ekiliyor | BatchSize={current_batch_size}")
                                            offset = 0
                                            batch_count = 0
                                            max_errors = 5
                                            error_count = 0
                                            max_retries = 5  # ArtÄ±rÄ±ldÄ±
                                            
                                            while True:
                                                batch_count += 1
                                                if batch_count % 50 == 1:
                                                    print(f"ğŸ“¦ Batch {batch_count}: Offset {offset:,} - {offset + current_batch_size:,} (Size: {current_batch_size})")
                                                retry_count = 0
                                                batch_data = []
                                                original_batch_size = current_batch_size
                                                
                                                while retry_count < max_retries:
                                                    try:
                                                        safe_fields = [
                                                            'move_id', 'date', 'create_date', 'write_date',
                                                            'product_id', 'quantity', 'price_subtotal',
                                                            'currency_id', 'partner_id', 'analytic_account_id', 'id',
                                                        ]
                                                        batch_data = models.execute_kw(
                                                            db, uid_xmlrpc, password,
                                                            'account.move.line', 'search_read',
                                                            [month_domain],
                                                            {'fields': safe_fields, 'limit': current_batch_size, 'offset': offset}
                                                        )
                                                        break
                                                    except Exception as retry_error:
                                                        retry_count += 1
                                                        error_msg = str(retry_error)[:200]
                                                        print(f"âš ï¸ Batch {batch_count} Retry {retry_count}/{max_retries}: {error_msg}")
                                                        
                                                        # 500 Internal Server Error iÃ§in exponential backoff
                                                        if "500 Internal Server Error" in str(retry_error):
                                                            wait_time = min(3 * (2 ** retry_count), 30)
                                                            print(f"ğŸ”„ 500 Server Error - {wait_time}s bekleniyor...")
                                                            time.sleep(wait_time)
                                                            if retry_count >= max_retries:
                                                                print("âŒ Batch tÃ¼m denemeler baÅŸarÄ±sÄ±z, atlanÄ±yor...")
                                                                break
                                                            continue
                                                        
                                                        # XML parsing hatasÄ± iÃ§in agresif kÃ¼Ã§Ã¼ltme
                                                        if "not well-formed" in error_msg or "invalid token" in error_msg:
                                                            print("ğŸ”§ XML parsing hatasÄ±: batch boyutu agresif kÃ¼Ã§Ã¼ltÃ¼lÃ¼yor...")
                                                            current_batch_size = max(1, current_batch_size // 4)  # 1/4'e indir
                                                            print(f"ğŸ“¦ Yeni batch boyutu: {current_batch_size}")
                                                        
                                                        if retry_count >= max_retries:
                                                            print("âŒ Batch tÃ¼m denemeler baÅŸarÄ±sÄ±z, atlanÄ±yor...")
                                                            break
                                                        time.sleep(3)
                                                
                                                if not batch_data or len(batch_data) == 0:
                                                    print("âœ… Ay iÃ§i veri bitti!")
                                                    break
                                                
                                                try:
                                                    # Duplicate kontrolÃ¼ kaldÄ±rÄ±ldÄ± - direkt ekle
                                                    if batch_data:
                                                        all_data.extend(batch_data)
                                                    error_count = 0
                                                    current_batch_size = original_batch_size  # Reset
                                                    if len(batch_data) < current_batch_size:
                                                        print("âœ… Ay son batch tamamlandÄ±!")
                                                        break
                                                    offset += current_batch_size
                                                except Exception as e:
                                                    error_count += 1
                                                    print(f"âŒ Batch HATASI: {str(e)[:200]}")
                                                    print(f"ğŸ” Hata detayÄ±: Month={mm}, BatchSize={current_batch_size}, Offset={offset}")
                                                    if error_count >= max_errors:
                                                        print("âŒ Ã‡ok fazla hata, ay dÃ¶ngÃ¼sÃ¼ durduruluyor...")
                                                        break
                                                    time.sleep(5)
                                                    offset += current_batch_size
                                                    continue
                                else:
                                    # DiÄŸer tÃ¼m durumlar: mevcut tek dÃ¶ngÃ¼ stratejisi
                                    offset = 0
                                    batch_count = 0
                                    max_errors = 5
                                    error_count = 0
                                    max_retries = 5  # ArtÄ±rÄ±ldÄ±
                                    while True:
                                        batch_count += 1
                                        special_domain = domain
                                        current_batch_size = batch_size
                                        original_batch_size = batch_size
                                        if batch_count % 50 == 1:
                                            print(f"ğŸ“¦ Batch {batch_count}: Offset {offset:,} - {offset + current_batch_size:,} (Size: {current_batch_size})")
                                        retry_count = 0
                                        batch_data = []
                                        while retry_count < max_retries:
                                            try:
                                                safe_fields = [
                                                    'move_id', 'date', 'create_date', 'write_date',
                                                    'product_id', 'quantity', 'price_subtotal', 
                                                    'currency_id', 'partner_id', 'analytic_account_id', 'id'
                                                ]
                                                batch_data = models.execute_kw(
                                                    db, uid_xmlrpc, password,
                                                    'account.move.line', 'search_read',
                                                    [special_domain],
                                                    {'fields': safe_fields, 'limit': current_batch_size, 'offset': offset}
                                                )
                                                break
                                            except Exception as retry_error:
                                                retry_count += 1
                                                error_msg = str(retry_error)[:200]
                                                print(f"âš ï¸ Batch {batch_count} Retry {retry_count}/{max_retries}: {error_msg}")
                                                
                                                # 500 Internal Server Error iÃ§in exponential backoff
                                                if "500 Internal Server Error" in str(retry_error):
                                                    wait_time = min(3 * (2 ** retry_count), 30)
                                                    print(f"ğŸ”„ 500 Server Error - {wait_time}s bekleniyor...")
                                                    time.sleep(wait_time)
                                                    if retry_count >= max_retries:
                                                        print(f"âŒ Batch {batch_count} tÃ¼m denemeler baÅŸarÄ±sÄ±z, atlanÄ±yor...")
                                                        break
                                                    continue
                                                
                                                # XML parsing hatasÄ± iÃ§in agresif kÃ¼Ã§Ã¼ltme
                                                if "not well-formed" in error_msg or "invalid token" in error_msg:
                                                    print(f"ğŸ”§ XML parsing hatasÄ± tespit edildi, batch boyutu agresif kÃ¼Ã§Ã¼ltÃ¼lÃ¼yor...")
                                                    current_batch_size = max(1, current_batch_size // 4)  # 1/4'e indir
                                                    print(f"ğŸ“¦ Yeni batch boyutu: {current_batch_size}")
                                                
                                                if retry_count >= max_retries:
                                                    print(f"âŒ Batch {batch_count} tÃ¼m denemeler baÅŸarÄ±sÄ±z, atlanÄ±yor...")
                                                    break
                                                time.sleep(3)
                                        if not batch_data or len(batch_data) == 0:
                                            print(f"âœ… Batch {batch_count}: Veri bitti!")
                                            break
                                        try:
                                            # Duplicate kontrolÃ¼ kaldÄ±rÄ±ldÄ± - direkt ekle
                                            if batch_data:
                                                all_data.extend(batch_data)
                                            error_count = 0
                                            current_batch_size = original_batch_size  # Reset batch size
                                            if len(batch_data) < current_batch_size:
                                                print(f"âœ… Son batch tamamlandÄ±!")
                                                break
                                            offset += current_batch_size
                                        except Exception as e:
                                            error_count += 1
                                            print(f"âŒ Batch {batch_count} HATASI: {str(e)[:200]}")
                                            print(f"ğŸ” Hata detayÄ±: Domain={special_domain}, BatchSize={current_batch_size}, Offset={offset}")
                                            if error_count >= max_errors:
                                                print(f"âŒ Ã‡ok fazla hata ({max_errors}), durduruluyor...")
                                                break
                                            time.sleep(5)
                                            offset += current_batch_size
                                        continue
                                
                                print(f"\nâœ… TOPLAM {len(all_data)} fatura satÄ±rÄ± Ã§ekildi (XML-RPC)!")
                                print(f"ğŸ“Š Veri boyutu: ~{len(all_data) * 0.5 / 1024:.2f} MB")
                                
                                # EUR ve USD currency'lerini bul (EUR faturalar iÃ§in kur hesaplama)
                                print(f"\nğŸ’± EUR ve USD currency'leri bulunuyor...")
                                eur_currency = []
                                usd_currency = []
                                try:
                                    # EUR currency'yi bul
                                    eur_currency = models.execute_kw(
                                        db, uid_xmlrpc, password,
                                        'res.currency', 'search_read',
                                        [[('name', '=', 'EUR')]],
                                        {'fields': ['id', 'name'], 'limit': 1}
                                    )
                                    if eur_currency and len(eur_currency) > 0:
                                        print(f"âœ… EUR currency bulundu: ID {eur_currency[0]['id']}")
                                    else:
                                        print(f"âš ï¸ EUR currency bulunamadÄ±!")
                                    
                                    # USD currency'yi bul
                                    usd_currency = models.execute_kw(
                                        db, uid_xmlrpc, password,
                                        'res.currency', 'search_read',
                                        [[('name', '=', 'USD')]],
                                        {'fields': ['id', 'name'], 'limit': 1}
                                    )
                                    if usd_currency and len(usd_currency) > 0:
                                        print(f"âœ… USD currency bulundu: ID {usd_currency[0]['id']}")
                                    else:
                                        print(f"âš ï¸ USD currency bulunamadÄ±!")
                                except Exception as e:
                                    print(f"âš ï¸ Currency bulma hatasÄ±: {e}")
                                
                                # HÄ°BRÄ°T YÃ–NTEM: USD tutarlarÄ± VE ÅEHÄ°R bilgisini account.invoice.report'tan Ã§ek
                                print(f"\nğŸ’° USD tutarlarÄ± ve ÅŸehir bilgisi account.invoice.report'tan Ã§ekiliyor (HÄ°BRÄ°T YÃ–NTEM)...")
                                
                                # move.line ID'lerini topla
                                line_ids = [line.get('id') for line in all_data if line.get('id')]
                                print(f"ğŸ“¦ {len(line_ids)} satÄ±r iÃ§in USD tutar ve ÅŸehir Ã§ekilecek...")
                                
                                usd_amount_map = {}
                                state_id_map = {}  # Åehir bilgisi iÃ§in yeni map
                                usd_rate_map = {}  # KUR bilgisi iÃ§in yeni map
                                try:
                                    # account.invoice.report'tan USD tutarlarÄ±nÄ±, state_id ve usd_rate'i batch olarak Ã§ek
                                    # Retry mekanizmasÄ± eklendi (502 Bad Gateway hatalarÄ±nÄ± Ã¶nlemek iÃ§in)
                                    usd_batch_size = 5000  # 10000'den 5000'e dÃ¼ÅŸÃ¼rÃ¼ldÃ¼ (502 hatalarÄ±nÄ± Ã¶nlemek iÃ§in)
                                    max_retries = 3
                                    retry_delay = 2
                                    
                                    for i in range(0, len(line_ids), usd_batch_size):
                                        batch_ids = line_ids[i:i+usd_batch_size]
                                        batch_num = i//usd_batch_size + 1
                                        total_batches = (len(line_ids) + usd_batch_size - 1) // usd_batch_size
                                        
                                        # Log azaltÄ±ldÄ± (sadece her 5 batch'te)
                                        if (i // usd_batch_size) % 5 == 0:
                                            print(f"   ğŸ’µ USD batch {batch_num}/{total_batches}: {len(batch_ids)} kayÄ±t...")
                                        
                                        batch_success = False
                                        retry_count = 0
                                        
                                        while not batch_success and retry_count < max_retries:
                                            try:
                                                # account.invoice.report'tan price_usd_subtotal, state_id ve usd_rate Ã§ek
                                                usd_batch = models.execute_kw(
                                                    db, uid_xmlrpc, password,
                                                    'account.invoice.report', 'search_read',
                                                    [[('id', 'in', batch_ids)]],
                                                    {'fields': ['id', 'price_usd_subtotal', 'state_id', 'usd_rate']}
                                                )
                                                
                                                # BaÅŸarÄ±lÄ± - verileri iÅŸle
                                                for usd_record in usd_batch:
                                                    line_id = usd_record.get('id')
                                                    usd_subtotal = usd_record.get('price_usd_subtotal', 0)
                                                    state_id = usd_record.get('state_id')
                                                    usd_rate = usd_record.get('usd_rate', 0)
                                                    
                                                    usd_amount_map[line_id] = float(usd_subtotal) if usd_subtotal else 0
                                                    
                                                    # state_id'yi ÅŸehir adÄ±na Ã§evir
                                                    if state_id and isinstance(state_id, list) and len(state_id) > 1:
                                                        state_id_map[line_id] = state_id[1]  # [id, name] formatÄ±nda geliyor
                                                    else:
                                                        state_id_map[line_id] = 'Bilinmeyen'
                                                    
                                                    # usd_rate'i kaydet
                                                    if usd_rate and float(usd_rate) > 0:
                                                        usd_rate_map[line_id] = float(usd_rate)
                                                
                                                batch_success = True
                                                
                                            except Exception as batch_error:
                                                retry_count += 1
                                                error_msg = str(batch_error)[:300]
                                                
                                                if retry_count < max_retries:
                                                    print(f"   âš ï¸ USD batch {batch_num} hatasÄ± (Deneme {retry_count}/{max_retries}): {error_msg}...")
                                                    print(f"   â³ {retry_delay} saniye bekleniyor...")
                                                    from time import sleep
                                                    sleep(retry_delay)
                                                else:
                                                    print(f"   âŒ USD batch {batch_num} baÅŸarÄ±sÄ±z: {len(batch_ids)} kayÄ±t atlandÄ±")
                                                    print(f"   Hata: {error_msg}")
                                                    # Bu batch atlanÄ±yor ama diÄŸer batch'ler Ã§alÄ±ÅŸmaya devam edecek
                                                    batch_success = True  # Loop'u bitir, bir sonraki batch'e geÃ§
                                    
                                    print(f"âœ… {len(usd_amount_map)} satÄ±r iÃ§in USD tutar eÅŸleÅŸtirildi!")
                                    print(f"âœ… {len(state_id_map)} satÄ±r iÃ§in ÅŸehir bilgisi eÅŸleÅŸtirildi!")
                                    print(f"âœ… {len(usd_rate_map)} satÄ±r iÃ§in KUR bilgisi eÅŸleÅŸtirildi!")
                                    
                                    # Ä°statistik
                                    with_usd = sum(1 for v in usd_amount_map.values() if v != 0)
                                    total_usd = sum(usd_amount_map.values())
                                    with_city = sum(1 for c in state_id_map.values() if c != 'Bilinmeyen')
                                    with_rate = len(usd_rate_map)
                                    print(f"   ğŸ’° USD olan: {with_usd}")
                                    print(f"   ğŸ’µ Toplam USD: ${total_usd:,.2f}")
                                    print(f"   ğŸ™ï¸ Åehir bilgisi olan: {with_city}")
                                    print(f"   ğŸ’± KUR bilgisi olan: {with_rate}")
                                    
                                except Exception as e:
                                    print(f"âš ï¸ USD tutar + ÅŸehir + kur Ã§ekme hatasÄ±: {e}")
                                    print(f"âš ï¸ Fallback: account.move'dan currency_rate Ã§ekilecek")
                                    usd_amount_map = {}
                                    state_id_map = {}
                                    usd_rate_map = {}
                                
                                # SatÄ±ÅŸ temsilcileri ve KUR bilgilerini Ã§ek (account.move'dan)
                                print(f"\nğŸ‘¤ SatÄ±ÅŸ temsilcileri ve KUR bilgileri Ã§ekiliyor...")
                                move_ids = list(set([line.get('move_id')[0] for line in all_data if line.get('move_id') and isinstance(line.get('move_id'), list)]))
                                print(f"ğŸ“¦ {len(move_ids)} fatura baÅŸlÄ±ÄŸÄ± iÃ§in satÄ±ÅŸ temsilcisi ve kur Ã§ekiliyor (10000'erlik batch)...")
                                
                                invoice_user_map = {}
                                invoice_datetime_map = {}  # Fatura kesilme zamanÄ± (saat iÃ§in)
                                invoice_date_map = {}  # GerÃ§ek fatura tarihi
                                move_type_map = {}  # Fatura tipi (iade kontrolÃ¼ iÃ§in)
                                invoice_currency_rate_map = {}  # Fatura kuru (USD hesabÄ± iÃ§in)
                                
                                # Batch size kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ ve her batch iÃ§in ayrÄ± try-except (daha gÃ¼venli)
                                move_batch_size = 5000  # 10000'den 5000'e dÃ¼ÅŸÃ¼rÃ¼ldÃ¼
                                max_retries = 3
                                retry_delay = 2
                                
                                for i in range(0, len(move_ids), move_batch_size):
                                    batch_ids = move_ids[i:i+move_batch_size]
                                    batch_num = i//move_batch_size + 1
                                    total_batches = (len(move_ids) + move_batch_size - 1) // move_batch_size
                                    
                                    batch_success = False
                                    retry_count = 0
                                    
                                    while not batch_success and retry_count < max_retries:
                                        try:
                                            print(f"   ğŸ“¦ Fatura batch {batch_num}/{total_batches}: {len(batch_ids)} fatura...")
                                            
                                            # Field'lar: pricelist_id kaldÄ±rÄ±ldÄ± (Odoo'da yok)
                                            fields_to_use = ['id', 'invoice_user_id', 'user_id', 'create_date', 'invoice_date', 'move_type', 'currency_rate', 'amount_total', 'amount_total_signed']
                                            
                                            batch_moves = models.execute_kw(
                                                db, uid_xmlrpc, password,
                                                'account.move', 'search_read',
                                                [[('id', 'in', batch_ids)]],
                                                {'fields': fields_to_use}
                                            )
                                            
                                            # BaÅŸarÄ±lÄ± - verileri iÅŸle
                                            for move in batch_moves:
                                                move_id = move['id']
                                                
                                                # SatÄ±ÅŸ temsilcisi
                                                if move.get('invoice_user_id') and isinstance(move.get('invoice_user_id'), list):
                                                    invoice_user_map[move_id] = move['invoice_user_id'][1]
                                                elif move.get('user_id') and isinstance(move.get('user_id'), list):
                                                    invoice_user_map[move_id] = move['user_id'][1]
                                                else:
                                                    invoice_user_map[move_id] = 'Sistem'
                                                
                                                # Fatura kesilme zamanÄ± (tarih + saat)
                                                if move.get('create_date'):
                                                    invoice_datetime_map[move_id] = move['create_date']
                                                
                                                # GerÃ§ek fatura tarihi
                                                if move.get('invoice_date'):
                                                    invoice_date_map[move_id] = move['invoice_date']
                                                
                                                # Fatura tipi (iade kontrolÃ¼ iÃ§in)
                                                if move.get('move_type'):
                                                    move_type_map[move_id] = move['move_type']
                                                
                                                # KUR bilgisi (USD hesabÄ± iÃ§in)
                                                if move.get('currency_rate'):
                                                    invoice_currency_rate_map[move_id] = float(move['currency_rate'])
                                            
                                            batch_success = True
                                            
                                        except Exception as batch_error:
                                            retry_count += 1
                                            error_msg = str(batch_error)[:300]
                                            
                                            if retry_count < max_retries:
                                                print(f"   âš ï¸ Batch {batch_num} hatasÄ± (Deneme {retry_count}/{max_retries}): {error_msg}...")
                                                print(f"   â³ {retry_delay} saniye bekleniyor...")
                                                from time import sleep
                                                sleep(retry_delay)
                                            else:
                                                print(f"   âŒ Batch {batch_num} baÅŸarÄ±sÄ±z: {len(batch_ids)} fatura atlandÄ±")
                                                print(f"   Hata: {error_msg}")
                                                # Bu batch atlanÄ±yor ama diÄŸer batch'ler Ã§alÄ±ÅŸmaya devam edecek
                                                batch_success = True  # Loop'u bitir, bir sonraki batch'e geÃ§
                                
                                print(f"âœ… {len(invoice_user_map)} fatura iÃ§in satÄ±ÅŸ temsilcisi eÅŸleÅŸtirildi!")
                                print(f"âœ… {len(invoice_datetime_map)} fatura iÃ§in tarih-saat bilgisi alÄ±ndÄ±!")
                                print(f"âœ… {len(invoice_date_map)} fatura iÃ§in gerÃ§ek tarih alÄ±ndÄ±!")
                                print(f"âœ… {len(move_type_map)} fatura iÃ§in tip bilgisi alÄ±ndÄ±!")
                                print(f"âœ… {len(invoice_currency_rate_map)} fatura iÃ§in KUR bilgisi alÄ±ndÄ±!")
                                
                            except Exception as e:
                                print(f"âŒ XML-RPC veri Ã§ekme hatasÄ±: {e}")
                                all_data = None
                        else:
                            all_data = None
                        
                        if all_data and len(all_data) > 0:
                            
                            # Verileri iÅŸle ve JSON oluÅŸtur
                            print("\n2ï¸âƒ£ Veriler iÅŸleniyor ve kategorilere ayrÄ±lÄ±yor...")
                            
                            processed_data = {
                                'categories': {},
                                'products': {},
                                'partners': {},
                                'sales_persons': {},
                                'cities': {},
                                'stores': {},  # MaÄŸaza bilgisi (analytic_account)
                                'years': {},
                                'months': {},
                                'raw_count': len(all_data),
                                'last_update': datetime.now().isoformat()
                            }
                            
                            # Ã–nce Ã¼rÃ¼n kategorilerini ve partner ÅŸehirlerini Ã§ek (XML-RPC)
                            print("ğŸ“¦ ÃœrÃ¼n kategorileri Ã§ekiliyor (HiyerarÅŸik - XML-RPC)...")
                            
                            product_ids = list(set([line.get('product_id')[0] for line in all_data if line.get('product_id') and isinstance(line.get('product_id'), list)]))
                            partner_ids = list(set([line.get('partner_id')[0] for line in all_data if line.get('partner_id') and isinstance(line.get('partner_id'), list)]))
                            
                            product_categ_map = {}
                            product_brand_map = {}
                            product_type_map = {}  # ÃœrÃ¼n tipi map'i (service/product/consu)
                            product_detailed_type_map = {}  # ÃœrÃ¼n detailed_type map'i
                            product_list_price_map = {}  # ÃœrÃ¼n list_price map'i (indirim hesaplama iÃ§in)
                            category_hierarchy = {}
                            partner_city_map = {}  # Ä°L bilgisi (state_id)
                            partner_district_map = {}  # Ä°LÃ‡E bilgisi (city)
                            partner_tags_map = {}
                            
                            if product_ids and models:  # TÃœM ÃœRÃœNLER
                                try:
                                    # ÃœrÃ¼nleri BATCH Ã§ek - TÃœM ÃœRÃœNLER (kategori + marka)
                                    product_batch_size = 10000
                                    print(f"ğŸ“¦ {len(product_ids)} Ã¼rÃ¼n Ã§ekiliyor (10000'erlik batch)...")
                                    products = []
                                    for i in range(0, len(product_ids), product_batch_size):
                                        batch_ids = product_ids[i:i+product_batch_size]
                                        print(f"   ğŸ“¦ ÃœrÃ¼n batch {i//product_batch_size + 1}: {len(batch_ids)} Ã¼rÃ¼n...")
                                        batch_products = models.execute_kw(
                                            db, uid_xmlrpc, password,
                                            'product.product', 'search_read',
                                            [[('id', 'in', batch_ids)]],
                                            {'fields': ['id', 'categ_id', 'product_brand_id', 'product_tmpl_id', 'type', 'detailed_type', 'list_price'], 'context': {'active_test': False}}
                                        )
                                        products.extend(batch_products)
                                    print(f"âœ… Toplam {len(products)} Ã¼rÃ¼n Ã§ekildi!")
                                    
                                    # Kategori ID'lerini topla
                                    categ_ids = list(set([prod['categ_id'][0] for prod in products if prod.get('categ_id') and isinstance(prod.get('categ_id'), list)]))
                                    
                                    # TÃ¼m kategorileri Ã§ek (parent bilgisiyle)
                                    print(f"ğŸ“‚ {len(categ_ids)} kategori detayÄ± Ã§ekiliyor...")
                                    categories = models.execute_kw(
                                        db, uid_xmlrpc, password,
                                        'product.category', 'search_read',
                                        [[('id', 'in', categ_ids)]],
                                        {'fields': ['id', 'name', 'parent_id', 'complete_name']}
                                    )
                                    
                                    # Kategori hiyerarÅŸisini oluÅŸtur (5 seviyeye kadar)
                                    for cat in categories:
                                        cat_id = cat['id']
                                        cat_name = cat.get('complete_name') or cat.get('name')
                                        parent_name = cat['parent_id'][1] if cat.get('parent_id') and isinstance(cat.get('parent_id'), list) else None
                                        
                                        # Kategori yolunu parÃ§ala (Ã¶rn: "MÃ¼zik / Gitarlar / Elektro" -> ["MÃ¼zik", "Gitarlar", "Elektro"])
                                        cat_levels = cat_name.split(' / ') if ' / ' in cat_name else [cat_name]
                                        
                                        category_hierarchy[cat_id] = {
                                            'name': cat_name,
                                            'parent': parent_name,
                                            'full_path': cat_name,
                                            'level1': cat_levels[0] if len(cat_levels) > 0 else '',
                                            'level2': cat_levels[1] if len(cat_levels) > 1 else '',
                                            'level3': cat_levels[2] if len(cat_levels) > 2 else '',
                                            'level4': cat_levels[3] if len(cat_levels) > 3 else '',
                                            'level5': cat_levels[4] if len(cat_levels) > 4 else ''
                                        }
                                    
                                    # ÃœrÃ¼n-kategori ve marka eÅŸleÅŸtirmesi
                                    product_brand_map = {}
                                    for prod in products:
                                        prod_id = prod['id']
                                        
                                        # ÃœrÃ¼n tipi (service/product/consu) - Hem type hem detailed_type kontrol et
                                        product_type = prod.get('type', '') or prod.get('detailed_type', '')
                                        product_type_map[prod_id] = product_type
                                        product_detailed_type_map[prod_id] = prod.get('detailed_type', '') or prod.get('type', '')
                                        
                                        # Kategori
                                        categ = prod.get('categ_id')
                                        if categ and isinstance(categ, list) and len(categ) > 0:
                                            cat_id = categ[0]
                                            if cat_id in category_hierarchy:
                                                product_categ_map[prod_id] = category_hierarchy[cat_id]['full_path']
                                            else:
                                                product_categ_map[prod_id] = categ[1] if len(categ) > 1 else 'DiÄŸer'
                                        else:
                                            product_categ_map[prod_id] = 'DiÄŸer'
                                        
                                        # Marka
                                        brand = None
                                        if prod.get('product_brand_id') and isinstance(prod.get('product_brand_id'), list):
                                            brand = prod['product_brand_id'][1]
                                        
                                        product_brand_map[prod_id] = brand if brand else 'Bilinmeyen'
                                        
                                        # List Price (indirim hesaplama iÃ§in)
                                        list_price = float(prod.get('list_price', 0))
                                        product_list_price_map[prod_id] = list_price
                                    
                                    print(f"âœ… {len(product_categ_map)} Ã¼rÃ¼n kategorisi eÅŸleÅŸtirildi (XML-RPC)")
                                    print(f"âœ… {len(product_brand_map)} Ã¼rÃ¼n markasÄ± eÅŸleÅŸtirildi")
                                    print(f"âœ… {len(category_hierarchy)} kategori hiyerarÅŸisi oluÅŸturuldu (5 seviye)!")
                                    
                                    # Kategori hiyerarÅŸisini data'ya ekle
                                    processed_data['category_hierarchy'] = category_hierarchy
                                    
                                except Exception as e:
                                    print(f"âš ï¸ ÃœrÃ¼n kategorisi Ã§ekme hatasÄ±: {e}")
                                    category_hierarchy = {}
                                    product_brand_map = {}
                            
                            # Partner ÅŸehir bilgilerini Ã§ek (XML-RPC) - HÄ°BRÄ°T YÃ–NTEM (state_id dahil) - TÃœM PARTNER
                            print(f"\nğŸ™ï¸ Partner ÅŸehir bilgileri Ã§ekiliyor (TÃœM PARTNER: {len(partner_ids)})...")
                            if partner_ids and models:
                                try:
                                    # Partnerleri BATCH Ã§ek (10000'erlik)
                                    partner_batch_size = 10000
                                    print(f"ğŸ“¦ {len(partner_ids)} partner Ã§ekiliyor (10000'erlik batch)...")
                                    partners = []
                                    for i in range(0, len(partner_ids), partner_batch_size):
                                        batch_ids = partner_ids[i:i+partner_batch_size]
                                        print(f"   ğŸ“¦ Partner batch {i//partner_batch_size + 1}: {len(batch_ids)} partner...")
                                        batch_partners = models.execute_kw(
                                            db, uid_xmlrpc, password,
                                            'res.partner', 'search_read',
                                            [[('id', 'in', batch_ids)]],
                                            {'fields': ['id', 'name', 'city', 'state_id']}
                                        )
                                        partners.extend(batch_partners)
                                    print(f"âœ… Toplam {len(partners)} partner Ã§ekildi!")
                                    
                                    # Åehir listesi (partner adÄ±ndan Ã§Ä±karmak iÃ§in)
                                    city_keywords = [
                                        'Ä°stanbul', 'Ankara', 'Ä°zmir', 'Antalya', 'Bursa', 'Adana', 
                                        'Konya', 'Gaziantep', 'ÅanlÄ±urfa', 'Kocaeli', 'Mersin', 
                                        'DiyarbakÄ±r', 'Hatay', 'Manisa', 'Kayseri', 'Samsun',
                                        'BalÄ±kesir', 'KahramanmaraÅŸ', 'Van', 'AydÄ±n', 'Denizli',
                                        'Sakarya', 'TekirdaÄŸ', 'MuÄŸla', 'EskiÅŸehir', 'Mardin',
                                        'Malatya', 'Erzurum', 'Trabzon', 'ElazÄ±ÄŸ', 'Ordu',
                                        'Ã‡orum', 'Afyonkarahisar', 'Sivas', 'Tokat', 'Giresun',
                                        'Aksaray', 'NiÄŸde', 'NevÅŸehir', 'KÄ±rÄ±kkale', 'KÄ±rÅŸehir',
                                        'Bodrum', 'TÃ¼nel', 'Hilltown', 'Uniq', 'Akasya', 'Kanyon',
                                        'Zorlu', 'Emaar', 'Marmara', 'Optimum', 'Capacity', 'Forum',
                                        'Cevahir', 'Metropol', 'Palladium', 'Galleria', 'Mall of'
                                    ]
                                    
                                    for partner in partners:
                                        partner_id = partner['id']
                                        partner_name = partner.get('name', '')
                                        city_field = partner.get('city', '').strip()
                                        state_field = partner.get('state_id')
                                        
                                        # Ä°LÃ‡E bilgisi (city alanÄ±ndan)
                                        if city_field and city_field != '':
                                            partner_district_map[partner_id] = city_field
                                        else:
                                            partner_district_map[partner_id] = ''
                                        
                                        # Ä°L bilgisi (state_id'den)
                                        # 1. Ã–nce state_id'den (Ä°l/BÃ¶lge bilgisi - en doÄŸru)
                                        if state_field and isinstance(state_field, list) and len(state_field) > 1:
                                            partner_city_map[partner_id] = state_field[1]  # [id, name]
                                        # 2. Sonra city alanÄ±ndan
                                        elif city_field and city_field != '':
                                            partner_city_map[partner_id] = city_field
                                        else:
                                            # 3. Partner adÄ±ndan ÅŸehir Ã§Ä±kar
                                            found_city = None
                                            for city in city_keywords:
                                                if city.lower() in partner_name.lower():
                                                    found_city = city
                                                    break
                                            
                                            partner_city_map[partner_id] = found_city if found_city else 'Bilinmeyen'
                                    
                                    # Ä°statistik
                                    with_city = sum(1 for c in partner_city_map.values() if c != 'Bilinmeyen')
                                    print(f"âœ… {len(partner_city_map)} partner iÅŸlendi!")
                                    print(f"   ğŸ“ Åehir bilgisi olan: {with_city}")
                                    print(f"   â“ Bilinmeyen ÅŸehir: {len(partner_city_map) - with_city}")
                                    
                                except Exception as e:
                                    print(f"âš ï¸ Partner ÅŸehir bilgisi Ã§ekme hatasÄ±: {e}")
                                    partner_city_map = {}
                                    partner_tags_map = {}
                            
                            # Detay kayÄ±tlarÄ± iÃ§in liste
                            # Duplicate kontrolÃ¼ kaldÄ±rÄ±ldÄ± - all_data direkt kullanÄ±lÄ±yor
                            print(f"âœ… Veri hazÄ±r: {len(all_data)} kayÄ±t")
                            
                            details = []
                            
                            # Ä°ade faturalarÄ± istatistikleri
                            refund_count = 0
                            refund_total_usd = 0
                            invoice_count = 0
                            invoice_total_usd = 0
                            # Ä°ndirim ve hizmet istatistikleri
                            discount_count = 0
                            discount_total_usd = 0
                            service_count = 0
                            service_total_usd = 0
                            
                            # Ä°ÅŸleme sayacÄ± (debug iÃ§in)
                            processed_count = 0
                            
                            for line in all_data:
                                try:
                                    processed_count += 1
                                    
                                    # Hata yakalama iÃ§in line ID'yi al
                                    line_id_for_error = line.get('id', 'unknown')
                                    
                                    # Ã–NCE move bilgisini al
                                    move = line.get('move_id')
                                    move_id = move[0] if isinstance(move, list) else 0
                                    move_name = move[1] if isinstance(move, list) and len(move) > 1 else ''
                                    
                                    # Ä°ADE KONTROLÃœ: 
                                    # Format: RMRKZ/2024/00053 (EFT2024000000163)
                                    # Ä°ADE FATURALARI DAÄ°MA "R" ile baÅŸlar!
                                    is_refund = False
                                    if move_name and move_name.upper().startswith('R'):
                                        is_refund = True
                                    
                                    # Ek kontrol: move_type de kontrol et (Ã§ift gÃ¼venlik)
                                    move_type = move_type_map.get(move_id, '')
                                    if move_type == 'out_refund':
                                        is_refund = True
                                    
                                    # ÃœrÃ¼n
                                    product = line.get('product_id')
                                    product_name = product[1] if isinstance(product, list) and len(product) > 1 else 'Bilinmeyen'
                                    product_id = product[0] if isinstance(product, list) else 0
                                    
                                    # Ä°NDÄ°RÄ°M KONTROLÃœ: Ä°ndirim Ã¼rÃ¼nleri negatif olarak iÅŸaretlenecek
                                    # Ä°ndirim ifadesi geÃ§iyorsa VEYA Odoo'dan negatif deÄŸer geliyorsa â†’ negatif iÅŸaretle
                                    is_discount = False
                                    has_discount_text = product_name and ('indirim' in product_name.lower() or 'Ã¼cretsiz Ã¼rÃ¼n' in product_name.lower())
                                    if has_discount_text:
                                        is_discount = True
                                    
                                    # HÄ°ZMET KONTROLÃœ: Hizmet Ã¼rÃ¼nleri negatif olarak iÅŸaretlenecek
                                    is_service = False
                                    product_type = product_type_map.get(product_id, '')
                                    product_detailed_type = product_detailed_type_map.get(product_id, '')
                                    if (product_type and product_type.lower() == 'service') or (product_detailed_type and product_detailed_type.lower() == 'service'):
                                        is_service = True
                                    
                                    # Tarih - ODOO FÄ°LTRESÄ° Ä°LE UYUMLU
                                    # Odoo filtresi account.move.line.date kullanÄ±yor, bu yÃ¼zden sadece line.date kullanÄ±yoruz
                                    # invoice_date kullanmÄ±yoruz Ã§Ã¼nkÃ¼ filtre ile uyumsuz (yÄ±l tutarsÄ±zlÄ±ÄŸÄ±na neden oluyor)
                                    date_str = line.get('date', '')
                                    if date_str:
                                        year = date_str[:4]
                                        month = date_str[:7]
                                    else:
                                        year = 'Bilinmeyen'
                                        month = 'Bilinmeyen'
                                    
                                    # Saat bilgisi - account.move'dan create_date (FATURA KESÄ°LME ZAMANI)
                                    create_hour = 0
                                    create_day_of_week = 0
                                    
                                    create_date_str = invoice_datetime_map.get(move_id, '')
                                    if create_date_str:
                                        try:
                                            # Format: '2025-10-15 14:35:22'
                                            from datetime import datetime
                                            dt = datetime.strptime(create_date_str, '%Y-%m-%d %H:%M:%S')
                                            create_hour = dt.hour
                                            create_day_of_week = dt.weekday()  # 0=Pazartesi, 6=Pazar
                                        except:
                                            pass
                                    
                                    # Kategori (Ã¼rÃ¼n map'inden)
                                    categ_name = product_categ_map.get(product_id, 'DiÄŸer')
                                    
                                    # MÃ¼ÅŸteri/MaÄŸaza
                                    partner = line.get('partner_id')
                                    partner_name = partner[1] if isinstance(partner, list) and len(partner) > 1 else 'Bilinmeyen'
                                    partner_id = partner[0] if isinstance(partner, list) else 0
                                    
                                    # Åehir ve Ä°lÃ§e bilgilerini al
                                    line_id = line.get('id')
                                    
                                    # HÄ°BRÄ°T ÅEHIR: 1. state_id (en doÄŸru) â†’ 2. partner city â†’ 3. Bilinmeyen
                                    city = state_id_map.get(line_id) or partner_city_map.get(partner_id, 'Bilinmeyen')
                                    partner_district = partner_district_map.get(partner_id, '')  # Ä°LÃ‡E (res.partner.city)
                                    
                                    # MaÄŸaza - analytic_account_id'den
                                    analytic_account = line.get('analytic_account_id')
                                    store_name = analytic_account[1] if isinstance(analytic_account, list) and len(analytic_account) > 1 else 'Genel'
                                    
                                    # SatÄ±ÅŸ temsilcisi - invoice_user_map'ten al
                                    move_id_value = line.get('move_id')
                                    move_id_int = move_id_value[0] if isinstance(move_id_value, list) else 0
                                    user_name = invoice_user_map.get(move_id_int, 'Sistem')
                                    
                                    # SayÄ±sal deÄŸerler - ORÄ°JÄ°NAL DEÄERLERÄ° AL (abs() almadan)
                                    original_qty = float(line.get('quantity', 0))
                                    original_price_subtotal = float(line.get('price_subtotal', 0))
                                    
                                    # ODOO'DAN NEGATÄ°F DEÄER KONTROLÃœ
                                    is_negative_from_odoo = (original_qty < 0) or (original_price_subtotal < 0)
                                    
                                    qty = abs(original_qty)  # Ä°ÅŸaret kontrolÃ¼ iÃ§in abs() al
                                    
                                    # USD tutar - HÄ°BRÄ°T YÃ–NTEM (5 KatmanlÄ± Fallback - Currency Ã–ncelikli)
                                    line_id = line.get('id')
                                    price_subtotal = abs(original_price_subtotal)  # Tutar (mutlak deÄŸer)
                                    
                                    # Ã–NCELÄ°K 1: Currency kontrolÃ¼ (USD/EUR/TL fatura mÄ±?)
                                    currency = line.get('currency_id')
                                    currency_code = currency[1] if isinstance(currency, list) and len(currency) > 1 else ''
                                    
                                    if 'USD' in currency_code.upper():
                                        # USD FATURA - Kura bÃ¶lme! Direkt al
                                        usd_amount = price_subtotal
                                        print(f"      ğŸ’µ USD Fatura tespit edildi: {move_name} - ${usd_amount:.2f}")
                                    elif 'EUR' in currency_code.upper():
                                        # EUR FATURA - USD faturalar gibi tespit et, sonra fatura tarihindeki kurlarÄ± kullan
                                        # 1. Fatura tarihini al
                                        invoice_date = date_str  # Fatura tarihi (YYYY-MM-DD formatÄ±nda)
                                        
                                        # 2. Fatura tarihindeki EUR/TRY ve USD/TRY kurlarÄ±nÄ± bul (res.currency.rate tablosundan)
                                        eur_usd_rate_for_invoice = None
                                        
                                        try:
                                            # EUR/TRY kuru (fatura tarihinde) - res.currency.rate tablosundan
                                            eur_rates_for_date = []
                                            if eur_currency and len(eur_currency) > 0:
                                                eur_rates_for_date = models.execute_kw(
                                                    db, uid_xmlrpc, password,
                                                    'res.currency.rate', 'search_read',
                                                    [
                                                        [
                                                            ('currency_id', '=', eur_currency[0]['id']),
                                                            ('name', '<=', invoice_date)
                                                        ]
                                                    ],
                                                    {
                                                        'fields': ['name', 'rate', 'currency_id'],
                                                        'order': 'name desc',
                                                        'limit': 1
                                                    }
                                                )
                                            
                                            # USD/TRY kuru (fatura tarihinde) - res.currency.rate tablosundan
                                            usd_rates_for_date = []
                                            if usd_currency and len(usd_currency) > 0:
                                                usd_rates_for_date = models.execute_kw(
                                                    db, uid_xmlrpc, password,
                                                    'res.currency.rate', 'search_read',
                                                    [
                                                        [
                                                            ('currency_id', '=', usd_currency[0]['id']),
                                                            ('name', '<=', invoice_date)
                                                        ]
                                                    ],
                                                    {
                                                        'fields': ['name', 'rate', 'currency_id'],
                                                        'order': 'name desc',
                                                        'limit': 1
                                                    }
                                                )
                                            
                                            # Parite hesapla: EUR/USD = (EUR/TRY) / (USD/TRY)
                                            if eur_rates_for_date and len(eur_rates_for_date) > 0 and usd_rates_for_date and len(usd_rates_for_date) > 0:
                                                # Odoo'da rate deÄŸeri: 1 base_currency = rate * currency
                                                # Base currency genellikle TRY, yani rate = 1 TRY = X EUR veya 1 TRY = X USD
                                                # Bu durumda: 1 EUR = 1/rate_EUR TRY ve 1 USD = 1/rate_USD TRY
                                                eur_rate_value = float(eur_rates_for_date[0].get('rate', 0))
                                                usd_rate_value = float(usd_rates_for_date[0].get('rate', 0))
                                                
                                                if eur_rate_value > 0 and usd_rate_value > 0:
                                                    # Ters kurlar: 1 EUR = X TRY ve 1 USD = Y TRY
                                                    eur_try_rate = 1.0 / eur_rate_value  # 1 EUR = X TRY
                                                    usd_try_rate = 1.0 / usd_rate_value  # 1 USD = Y TRY
                                                    
                                                    # EUR/USD paritesi: (EUR/TRY) / (USD/TRY)
                                                    eur_usd_rate_for_invoice = eur_try_rate / usd_try_rate
                                                    
                                                    # USD'ye Ã§evir
                                                    usd_amount = price_subtotal * eur_usd_rate_for_invoice
                                                    print(f"      ğŸ’¶ EUR Fatura tespit edildi: {move_name} - â‚¬{price_subtotal:.2f} = ${usd_amount:.2f} (Tarih: {invoice_date}, Kur: {eur_usd_rate_for_invoice:.4f})")
                                                else:
                                                    # Fallback: Ortalama EUR/USD kuru
                                                    usd_amount = price_subtotal * 1.08
                                                    print(f"      âš ï¸ EUR Fatura (tarih kurlarÄ± hesaplanamadÄ±, ortalama kullanÄ±ldÄ±): {move_name} - â‚¬{price_subtotal:.2f} = ${usd_amount:.2f}")
                                            else:
                                                # Fallback: Ortalama EUR/USD kuru
                                                usd_amount = price_subtotal * 1.08
                                                print(f"      âš ï¸ EUR Fatura (tarih kurlarÄ± bulunamadÄ±, ortalama kullanÄ±ldÄ±): {move_name} - â‚¬{price_subtotal:.2f} = ${usd_amount:.2f}")
                                        except Exception as e:
                                            # Fallback: Ortalama EUR/USD kuru
                                            usd_amount = price_subtotal * 1.08
                                            print(f"      âš ï¸ EUR Fatura (hata, ortalama kullanÄ±ldÄ±): {move_name} - â‚¬{price_subtotal:.2f} = ${usd_amount:.2f}, Hata: {str(e)[:100]}")
                                    # Ã–NCELÄ°K 2: TL fatura iÃ§in usd_rate kullan
                                    elif line_id in usd_rate_map and usd_rate_map[line_id] > 0:
                                        # SatÄ±r bazÄ±nda kur varsa kullan (en doÄŸru!)
                                        usd_rate = usd_rate_map[line_id]
                                        usd_amount = price_subtotal / usd_rate
                                    elif line_id in usd_amount_map and usd_amount_map[line_id] != 0:
                                        # DoÄŸrudan USD tutarÄ± varsa kullan
                                        usd_amount = abs(usd_amount_map[line_id])
                                    # Ã–NCELÄ°K 3: account.move'dan fatura kuru
                                    elif move_id in invoice_currency_rate_map and invoice_currency_rate_map[move_id] > 0:
                                        currency_rate = invoice_currency_rate_map[move_id]
                                        usd_amount = price_subtotal / currency_rate
                                    # SON Ã‡ARE: Ortalama kur
                                    else:
                                        # Son Ã§are: ortalama kur (TL iÃ§in)
                                        usd_amount = price_subtotal / 34.5
                                    
                                    # HER ZAMAN POZÄ°TÄ°F OLARAK AL (move_type'a gÃ¶re sonra iÅŸaret belirleyeceÄŸiz)
                                    usd_amount = abs(usd_amount)
                                    qty = abs(qty)
                                    
                                    # Ä°ADE, Ä°NDÄ°RÄ°M VE HÄ°ZMET Ä°Ã‡Ä°N Ä°ÅARET KONTROLÃœ
                                    # NOT: Ä°ndirim/Ã¼cretsiz/hizmet/negatif satÄ±rlarÄ± istatistiklere eklenir ama sayfada gÃ¶sterilmez
                                    should_skip_display = False  # Sayfada gÃ¶sterilip gÃ¶sterilmeyeceÄŸini belirler
                                    
                                    if is_refund:
                                        # Ä°statistik
                                        refund_count += 1
                                        refund_total_usd += abs(usd_amount)
                                        
                                        # KRÄ°TÄ°K: Ä°ADE FATURALARI HER ZAMAN NEGATÄ°F OLMALI!
                                        # YukarÄ±da abs() aldÄ±k, ÅŸimdi negatif yap
                                        usd_amount = -abs(usd_amount)
                                        qty = -abs(qty)
                                    elif is_discount or (is_negative_from_odoo and has_discount_text):
                                        # Ä°ndirim istatistik: Ä°ndirim ifadesi geÃ§iyorsa VEYA (negatif deÄŸer VAR VE indirim ifadesi VAR)
                                        discount_count += 1
                                        discount_total_usd += abs(usd_amount)
                                        
                                        # Ä°NDÄ°RÄ°M ÃœRÃœNLERÄ° NEGATÄ°F OLARAK Ä°ÅARETLENÄ°R
                                        # YukarÄ±da abs() aldÄ±k, ÅŸimdi negatif yap (iade mantÄ±ÄŸÄ± ile aynÄ±)
                                        usd_amount = -abs(usd_amount)
                                        qty = -abs(qty)
                                        
                                        # KRÄ°TÄ°K: Ä°ndirim/Ã¼cretsiz satÄ±rlarÄ± sayfada GÃ–STERÄ°LMEZ (filtrelenir)
                                        should_skip_display = True
                                    elif is_service:
                                        # SERVICE TÄ°PÄ°NDE ÃœRÃœNLER - HER ZAMAN NEGATÄ°F OLARAK Ä°ÅARETLENÄ°R
                                        # Ä°statistik
                                        service_count += 1
                                        service_total_usd += abs(usd_amount)
                                        
                                        # KRÄ°TÄ°K: SERVICE ÃœRÃœNLERÄ° HER ZAMAN NEGATÄ°F OLMALI (Odoo'dan negatif gelip gelmediÄŸine bakÄ±lmaksÄ±zÄ±n)
                                        # YukarÄ±da abs() aldÄ±k, ÅŸimdi negatif yap (iade mantÄ±ÄŸÄ± ile aynÄ±)
                                        usd_amount = -abs(usd_amount)
                                        qty = -abs(qty)
                                        
                                        # KRÄ°TÄ°K: Service tipinde satÄ±rlar sayfada GÃ–STERÄ°LMEZ (filtrelenir)
                                        should_skip_display = True
                                    elif is_negative_from_odoo:
                                        # ODOO'DAN GELEN TÃœM NEGATÄ°F DEÄERLER (quantity < 0 veya price_subtotal < 0)
                                        # Ä°statistik (negatif deÄŸerler iÃ§in ayrÄ± kategori)
                                        discount_count += 1
                                        discount_total_usd += abs(usd_amount)
                                        
                                        # ODOO'DAN GELEN NEGATÄ°F DEÄERLER NEGATÄ°F OLARAK Ä°ÅARETLENÄ°R (iade gibi)
                                        # YukarÄ±da abs() aldÄ±k, ÅŸimdi negatif yap (iade mantÄ±ÄŸÄ± ile aynÄ±)
                                        usd_amount = -abs(usd_amount)
                                        qty = -abs(qty)
                                        
                                        # KRÄ°TÄ°K: Odoo'dan negatif gelen tÃ¼m satÄ±rlar sayfada GÃ–STERÄ°LMEZ (filtrelenir)
                                        should_skip_display = True
                                    else:
                                        # Normal satÄ±ÅŸ faturalarÄ± iÃ§in istatistik
                                        invoice_count += 1
                                        invoice_total_usd += usd_amount
                                    
                                    # Ä°NDÄ°RÄ°M/ÃœCRETSÄ°Z/HÄ°ZMET/NEGATÄ°F SATIRLARI SAYFADA GÃ–STERME
                                    # NOT: Bu satÄ±rlar artÄ±k continue ile atlanmÄ±yor - negatif deÄŸerleri ile veri dosyasÄ±na ekleniyor
                                    # Frontend'de is_service, is_discount veya should_skip_display kontrolÃ¼ ile filtrelenebilir
                                    # Ancak toplam hesaplamalarÄ±nda negatif deÄŸerleri ile dahil edilir (net hesaplama iÃ§in)
                                    
                                    # Kategori bazlÄ± toplama - SADECE USD VE MÄ°KTAR
                                    if categ_name not in processed_data['categories']:
                                        processed_data['categories'][categ_name] = {
                                            'quantity': 0, 'usd_amount': 0, 'years': {}
                                        }
                                    
                                    processed_data['categories'][categ_name]['quantity'] += qty
                                    processed_data['categories'][categ_name]['usd_amount'] += usd_amount
                                    
                                    if year not in processed_data['categories'][categ_name]['years']:
                                        processed_data['categories'][categ_name]['years'][year] = {
                                            'quantity': 0, 'usd_amount': 0
                                        }
                                    
                                    processed_data['categories'][categ_name]['years'][year]['quantity'] += qty
                                    processed_data['categories'][categ_name]['years'][year]['usd_amount'] += usd_amount
                                    
                                    # ÃœrÃ¼n bazlÄ± - SADECE USD VE MÄ°KTAR + MARKA + KATEGORÄ° SEVÄ°YELERÄ°
                                    if product_id not in processed_data['products']:
                                        # Kategori seviyelerini al
                                        cat_hierarchy = category_hierarchy.get(
                                            [k for k, v in product_categ_map.items() if k == product_id][0] if product_id in product_categ_map else None
                                        ) if product_id in product_categ_map else {}
                                        
                                        # Daha basit yÃ¶ntem: product_id'den kategori bilgisini al
                                        cat_info = {}
                                        for cat_id, cat_data in category_hierarchy.items():
                                            if product_categ_map.get(product_id) == cat_data.get('full_path'):
                                                cat_info = cat_data
                                                break
                                        
                                        processed_data['products'][product_id] = {
                                            'name': product_name,
                                            'category': categ_name,
                                            'brand': product_brand_map.get(product_id, 'Bilinmeyen'),
                                            'category_level1': cat_info.get('level1', ''),
                                            'category_level2': cat_info.get('level2', ''),
                                            'category_level3': cat_info.get('level3', ''),
                                            'category_level4': cat_info.get('level4', ''),
                                            'category_level5': cat_info.get('level5', ''),
                                            'quantity': 0,
                                            'usd_amount': 0
                                        }
                                    
                                    processed_data['products'][product_id]['quantity'] += qty
                                    processed_data['products'][product_id]['usd_amount'] += usd_amount
                                    
                                    # MÃ¼ÅŸteri/MaÄŸaza bazlÄ± - SADECE USD VE MÄ°KTAR + ÅEHÄ°R + Ä°LÃ‡E + ETÄ°KETLER
                                    if partner_id not in processed_data['partners']:
                                        processed_data['partners'][partner_id] = {
                                            'name': partner_name,
                                            'city': partner_district,  # Ä°LÃ‡E (res.partner.city)
                                            'partner_city': city,  # Ä°L (state_id)
                                            'quantity': 0,
                                            'usd_amount': 0
                                        }
                                    
                                    processed_data['partners'][partner_id]['quantity'] += qty
                                    processed_data['partners'][partner_id]['usd_amount'] += usd_amount
                                    
                                    # SatÄ±ÅŸ Temsilcisi bazlÄ± - SADECE USD VE MÄ°KTAR
                                    if user_name not in processed_data['sales_persons']:
                                        processed_data['sales_persons'][user_name] = {
                                            'quantity': 0, 'usd_amount': 0
                                        }
                                    
                                    processed_data['sales_persons'][user_name]['quantity'] += qty
                                    processed_data['sales_persons'][user_name]['usd_amount'] += usd_amount
                                    
                                    # Åehir bazlÄ± - SADECE USD VE MÄ°KTAR
                                    if city not in processed_data['cities']:
                                        processed_data['cities'][city] = {
                                            'quantity': 0, 'usd_amount': 0
                                        }
                                    
                                    processed_data['cities'][city]['quantity'] += qty
                                    processed_data['cities'][city]['usd_amount'] += usd_amount
                                    
                                    # MaÄŸaza bazlÄ± - SADECE USD VE MÄ°KTAR
                                    if store_name not in processed_data['stores']:
                                        processed_data['stores'][store_name] = {
                                            'quantity': 0, 'usd_amount': 0
                                        }
                                    
                                    processed_data['stores'][store_name]['quantity'] += qty
                                    processed_data['stores'][store_name]['usd_amount'] += usd_amount
                                    
                                    # YÄ±l bazlÄ± - SADECE USD VE MÄ°KTAR
                                    if year not in processed_data['years']:
                                        processed_data['years'][year] = {
                                            'quantity': 0, 'usd_amount': 0
                                        }
                                    
                                    processed_data['years'][year]['quantity'] += qty
                                    processed_data['years'][year]['usd_amount'] += usd_amount
                                    
                                    # Ay bazlÄ± - SADECE USD VE MÄ°KTAR
                                    if month not in processed_data['months']:
                                        processed_data['months'][month] = {
                                            'quantity': 0, 'usd_amount': 0
                                        }
                                    
                                    processed_data['months'][month]['quantity'] += qty
                                    processed_data['months'][month]['usd_amount'] += usd_amount
                                    
                                    # Detay kaydÄ± ekle - HÄ°BRÄ°T YAKLAÅIM:
                                    # Aggregated (partners, products, etc.) â†’ Net deÄŸerler (satÄ±ÅŸ - iade) âœ…
                                    # Details â†’ Her satÄ±r ayrÄ± (satÄ±ÅŸ + iade gÃ¶rÃ¼nÃ¼r) âœ…
                                    cat_info = {}
                                    for cat_id, cat_data in category_hierarchy.items():
                                        if product_categ_map.get(product_id) == cat_data.get('full_path'):
                                            cat_info = cat_data
                                            break
                                    
                                    details.append({
                                        'date': date_str,
                                        'create_hour': create_hour,
                                        'day_of_week': create_day_of_week,
                                        'partner': partner_name,
                                        'city': partner_district,  # Ä°LÃ‡E bilgisi (res.partner.city) - zaten yukarÄ±da tanÄ±mlÄ±
                                        'partner_city': city,  # Ä°L bilgisi (state_id) - zaten yukarÄ±da tanÄ±mlÄ±
                                        'product_id': product_id,  # Odoo unique ID - envanter ile eÅŸleÅŸtirme iÃ§in
                                        'product': product_name,
                                        'brand': product_brand_map.get(product_id, 'Bilinmeyen'),
                                        'category_1': cat_info.get('level1', ''),
                                        'category_2': cat_info.get('level2', ''),
                                        'category_3': cat_info.get('level3', ''),
                                        'category_4': cat_info.get('level4', ''),
                                        'sales_person': user_name,
                                        'store': store_name,
                                        'quantity': qty,  # Negatif olabilir (iade/indirim/hizmet)
                                        'usd_amount': usd_amount,  # Negatif olabilir (iade/indirim/hizmet)
                                        'is_refund': is_refund,  # Ä°ade mi deÄŸil mi?
                                        'is_discount': is_discount,  # Ä°ndirim mi deÄŸil mi?
                                        'is_service': is_service,  # Hizmet mi deÄŸil mi?
                                        'move_name': move_name  # Fatura numarasÄ±
                                    })
                                    
                                except ZeroDivisionError as e:
                                    print(f"âš ï¸ SatÄ±r iÅŸleme hatasÄ± (SÄ±fÄ±ra bÃ¶lme): Line ID {line_id_for_error}, Hata: {str(e)[:200]}")
                                    # Hata loglama iÃ§in devam et
                                    continue
                                except Exception as e:
                                    error_type = type(e).__name__
                                    error_msg = str(e)[:300]
                                    print(f"âš ï¸ SatÄ±r iÅŸleme hatasÄ±: Line ID {line_id_for_error}, Tip: {error_type}, Hata: {error_msg}")
                                    # Hata loglama iÃ§in devam et
                                    continue
                            
                            print("\nâœ… Veri iÅŸleme tamamlandÄ±!")
                            print(f"ğŸ“¦ Kategori sayÄ±sÄ±: {len(processed_data['categories'])}")
                            print(f"ğŸ·ï¸ ÃœrÃ¼n sayÄ±sÄ±: {len(processed_data['products'])}")
                            print(f"ğŸ¤ MÃ¼ÅŸteri sayÄ±sÄ±: {len(processed_data['partners'])}")
                            print(f"ğŸ“‹ Detay kayÄ±t sayÄ±sÄ±: {len(details)}")
                            print(f"ğŸ‘¤ SatÄ±ÅŸ Temsilcisi sayÄ±sÄ±: {len(processed_data['sales_persons'])}")
                            print(f"ğŸ™ï¸ Åehir sayÄ±sÄ±: {len(processed_data['cities'])}")
                            print(f"ğŸ“… YÄ±l sayÄ±sÄ±: {len(processed_data['years'])}")
                            print(f"ğŸ“† Ay sayÄ±sÄ±: {len(processed_data['months'])}")
                            print(f"\nğŸ’° FATURA Ä°STATÄ°STÄ°KLERÄ°:")
                            print(f"   âœ… SatÄ±ÅŸ FaturalarÄ± (out_invoice): {invoice_count} adet, ${invoice_total_usd:,.2f}")
                            print(f"   âŒ Ä°ade FaturalarÄ± (out_refund): {refund_count} adet, ${refund_total_usd:,.2f}")
                            print(f"   ğŸŸï¸ Ä°ndirim ÃœrÃ¼nleri: {discount_count} adet, ${discount_total_usd:,.2f}")
                            print(f"   ğŸ”§ Hizmet ÃœrÃ¼nleri: {service_count} adet, ${service_total_usd:,.2f}")
                            print(f"   ğŸ“Š NET TOPLAM: ${invoice_total_usd - refund_total_usd - discount_total_usd - service_total_usd:,.2f}")
                            
                            # RES.PARTNER (MÃ¼ÅŸteri) DetaylÄ± Bilgileri Ã‡ek (XML-RPC) - TÃœM MÃœÅTERÄ°LER
                            print("\n4ï¸âƒ£ MÃ¼ÅŸteri detay bilgileri Ã§ekiliyor (res.partner - XML-RPC)...")
                            
                            partner_ids = list(processed_data['partners'].keys())  # TÃœM MÃœÅTERÄ°LER
                            print(f"ğŸ‘¥ Toplam {len(partner_ids)} mÃ¼ÅŸteri detayÄ± Ã§ekilecek...")
                            
                            if partner_ids and models:
                                try:
                                    partners = models.execute_kw(
                                        db, uid_xmlrpc, password,
                                        'res.partner', 'search_read',
                                        [[('id', 'in', partner_ids)]],
                                        {
                                            'fields': [
                                                'id', 'name', 'email', 'phone', 'mobile',
                                                'street', 'city', 'state_id', 'country_id',
                                                'customer_rank', 'supplier_rank', 'company_type',
                                                'vat', 'category_id', 'user_id', 'create_date'
                                            ]
                                        }
                                    )
                                    
                                    partner_details = {}
                                    
                                    for partner in partners:
                                        partner_id = partner.get('id')
                                        
                                        state = partner.get('state_id')
                                        state_name = state[1] if isinstance(state, list) and len(state) > 1 else ''
                                        
                                        country = partner.get('country_id')
                                        country_name = country[1] if isinstance(country, list) and len(country) > 1 else ''
                                        
                                        categories = partner.get('category_id', [])
                                        category_names = [cat[1] for cat in categories if isinstance(cat, list) and len(cat) > 1] if categories else []
                                        
                                        user = partner.get('user_id')
                                        user_name = user[1] if isinstance(user, list) and len(user) > 1 else ''
                                        
                                        partner_details[partner_id] = {
                                            'name': partner.get('name', ''),
                                            'email': partner.get('email', ''),
                                            'phone': partner.get('phone', ''),
                                            'mobile': partner.get('mobile', ''),
                                            'street': partner.get('street', ''),
                                            'city': partner.get('city', ''),
                                            'state': state_name,
                                            'country': country_name,
                                            'customer_rank': partner.get('customer_rank', 0),
                                            'supplier_rank': partner.get('supplier_rank', 0),
                                            'company_type': partner.get('company_type', ''),
                                            'vat': partner.get('vat', ''),
                                            'categories': category_names,
                                            'sales_person': user_name,
                                            'create_date': partner.get('create_date', ''),
                                            'sales_data': processed_data['partners'].get(partner_id, {})
                                        }
                                    
                                    processed_data['partner_details'] = partner_details
                                    
                                    print(f"âœ… {len(partner_details)} mÃ¼ÅŸteri detayÄ± Ã§ekildi (XML-RPC)!")
                                    print(f"ğŸ“§ Email olan: {sum(1 for p in partner_details.values() if p['email'])}")
                                    print(f"ğŸ“± Telefon olan: {sum(1 for p in partner_details.values() if p['phone'] or p['mobile'])}")
                                    print(f"ğŸ™ï¸ Åehir bilgisi olan: {sum(1 for p in partner_details.values() if p['city'])}")
                                    
                                except Exception as e:
                                    print(f"âš ï¸ MÃ¼ÅŸteri detaylarÄ± Ã§ekme hatasÄ±: {e}")
                                    processed_data['partner_details'] = {}
                            else:
                                print("âš ï¸ MÃ¼ÅŸteri ID'leri yok veya XML-RPC baÄŸlantÄ±sÄ± yok")
                                processed_data['partner_details'] = {}
                            
                            # DetaylarÄ± processed_data'ya ekle
                            processed_data['details'] = details
                            
                            # JSON dosyalarÄ± oluÅŸtur (YILLARA BÃ–LÃœNMÃœÅ + GZIP)
                            print("\n5ï¸âƒ£ JSON dosyalarÄ± oluÅŸturuluyor (yÄ±llara bÃ¶lÃ¼nmÃ¼ÅŸ + sÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ)...")
                            
                            import gzip
                            from collections import defaultdict
                            
                            # MEVCUT VERÄ°LERÄ° KORUMA MANTIGI
                            print("\nğŸ”„ Mevcut veriler kontrol ediliyor...")
                            
                            # Mevcut dosyalarÄ± oku ve koru
                            existing_data = {}
                            for year in ['2023', '2024', '2025']:
                                filename = f'data-{year}.json.gz'
                                if os.path.exists(filename):
                                    try:
                                        with gzip.open(filename, 'rt', encoding='utf-8') as f:
                                            existing_data[year] = json.load(f)
                                        print(f"   âœ… {year}: {len(existing_data[year].get('details', []))} kayÄ±t (mevcut)")
                                    except Exception as e:
                                        print(f"   âš ï¸ {year}: Okuma hatasÄ± - {e}")
                                        existing_data[year] = None
                                else:
                                    print(f"   âŒ {year}: Dosya yok")
                                    existing_data[year] = None
                            
                            # Duplicate kontrolÃ¼ kaldÄ±rÄ±ldÄ± - details direkt kullanÄ±lÄ±yor
                            print(f"âœ… {len(details)} kayÄ±t iÅŸleniyor...")
                            
                            # Yeni verileri yÄ±llara gÃ¶re ayÄ±r
                            new_data_by_year = defaultdict(list)
                            for record in details:
                                year = record['date'][:4] if record.get('date') else '2025'
                                new_data_by_year[year].append(record)
                            
                            # Veri birleÅŸtirme stratejisi
                            if data_scope == 'specific_year':
                                print(f"ğŸ”„ SADECE {target_year} yÄ±lÄ± gÃ¼ncelleniyor, diÄŸerleri korunuyor...")
                                # Sadece seÃ§ilen yÄ±lÄ± gÃ¼ncelle, diÄŸerlerini koru
                                final_data_by_year = {}
                                for year in ['2023', '2024', '2025']:
                                    if year == target_year:
                                        # SeÃ§ilen yÄ±l: yeni veri
                                        final_data_by_year[year] = new_data_by_year.get(year, [])
                                        print(f"   ğŸ”„ {year}: {len(final_data_by_year[year])} kayÄ±t (YENÄ°)")
                                    else:
                                        # DiÄŸer yÄ±llar: mevcut veri
                                        if existing_data.get(year):
                                            final_data_by_year[year] = existing_data[year].get('details', [])
                                            print(f"   ğŸ”’ {year}: {len(final_data_by_year[year])} kayÄ±t (KORUNDU)")
                                        else:
                                            final_data_by_year[year] = []
                                            print(f"   âŒ {year}: Veri yok")
                            else:
                                print("ğŸ”„ TÃœM YILLAR gÃ¼ncelleniyor...")
                                # TÃ¼m yÄ±llarÄ± gÃ¼ncelle
                                final_data_by_year = dict(new_data_by_year)
                                for year in ['2023', '2024', '2025']:
                                    if year not in final_data_by_year:
                                        final_data_by_year[year] = []
                                    print(f"   ğŸ”„ {year}: {len(final_data_by_year[year])} kayÄ±t (YENÄ°)")
                            
                            print(f"\nğŸ“Š Final veri daÄŸÄ±lÄ±mÄ±:")
                            for year in sorted(final_data_by_year.keys()):
                                print(f"   - {year}: {len(final_data_by_year[year])} kayÄ±t")
                            
                            # Her yÄ±l iÃ§in ayrÄ± sÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ dosya oluÅŸtur
                            created_files = []
                            for year in sorted(final_data_by_year.keys()):
                                year_data = {
                                    'year': year,
                                    'categories': processed_data['categories'],
                                    'products': processed_data['products'],
                                    'partners': processed_data['partners'],
                                    'partner_details': processed_data['partner_details'],
                                    'sales_persons': processed_data['sales_persons'],
                                    'stores': processed_data['stores'],
                                    'years': processed_data['years'],
                                    'months': processed_data['months'],
                                    'details': final_data_by_year[year]
                                }
                                
                                filename = f'data-{year}.json.gz'
                                # GZIP Level 9: Maksimum sÄ±kÄ±ÅŸtÄ±rma (daha kÃ¼Ã§Ã¼k dosyalar)
                                with gzip.open(filename, 'wt', encoding='utf-8', compresslevel=9) as f:
                                    json.dump(year_data, f, ensure_ascii=False)
                                
                                # Dosya boyutunu kontrol et
                                import os
                                file_size_mb = os.path.getsize(filename) / (1024 * 1024)
                                print(f"   âœ… {filename}: {file_size_mb:.2f} MB")
                                created_files.append(filename)
                            
                            # Metadata dosyasÄ± oluÅŸtur (hangi yÄ±llar var?)
                            total_records = sum(len(records) for records in final_data_by_year.values())
                            metadata = {
                                'years': sorted(final_data_by_year.keys()),
                                'total_records': total_records,
                                'files': created_files,
                                'last_update': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                                'data_scope': data_scope,
                                'target_year': target_year if data_scope == 'specific_year' else None
                            }
                            
                            with open('data-metadata.json', 'w', encoding='utf-8') as f:
                                json.dump(metadata, f, ensure_ascii=False, indent=2)
                            
                            print(f"âœ… {len(created_files)} dosya oluÅŸturuldu!")
                            print(f"âœ… data-metadata.json oluÅŸturuldu!")
                            
                            # ENVANTER VERÄ°SÄ° Ã‡EK (YENÄ°!)
                            print("\n" + "=" * 60)
                            print("ğŸ“¦ ENVANTER VERÄ°SÄ° Ã‡EKÄ°LÄ°YOR")
                            print("=" * 60)
                            
                            try:
                                # PerakendeStok filtresini bul
                                print("ğŸ” 'PerakendeStok' filtresi aranÄ±yor...")
                                
                                inventory_filters = models.execute_kw(
                                    db, uid_xmlrpc, password,
                                    'ir.filters', 'search_read',
                                    [[
                                        ('user_id', '=', uid_xmlrpc),
                                        ('name', '=', 'PerakendeStok')
                                    ]],
                                    {'fields': ['name', 'domain', 'model_id']}
                                )
                                
                                if inventory_filters and len(inventory_filters) > 0:
                                    inv_filter = inventory_filters[0]
                                    print(f"âœ… PerakendeStok filtresi bulundu!")
                                    print(f"ğŸ“‹ Model: {inv_filter.get('model_id')}")
                                    print(f"ğŸ“‹ Domain: {inv_filter['domain']}")
                                    
                                    # Domain'i parse et
                                    inv_domain = ast.literal_eval(inv_filter['domain']) if inv_filter['domain'] else []
                                    
                                    # stock.quant'tan envanter verilerini Ã§ek
                                    print("ğŸ“¦ Envanter verileri Ã§ekiliyor...")
                                    
                                    inventory_data = models.execute_kw(
                                        db, uid_xmlrpc, password,
                                        'stock.quant', 'search_read',
                                        [inv_domain],
                                        {
                                            'fields': [
                                                'id', 'product_id', 'location_id',
                                                'quantity', 'reserved_quantity',
                                                'available_quantity', 'lot_id',
                                                'package_id', 'owner_id'
                                            ]
                                        }
                                    )
                                    
                                    print(f"âœ… {len(inventory_data)} envanter kaydÄ± Ã§ekildi!")
                                    
                                    # ÃœrÃ¼n detaylarÄ±nÄ± Ã§ek
                                    product_ids = list(set([item['product_id'][0] for item in inventory_data if item.get('product_id')]))
                                    print(f"ğŸ“¦ {len(product_ids)} Ã¼rÃ¼n detayÄ± Ã§ekiliyor...")
                                    
                                    products = models.execute_kw(
                                        db, uid_xmlrpc, password,
                                        'product.product', 'search_read',
                                        [[('id', 'in', product_ids)]],
                                        {
                                            'fields': [
                                                'id', 'name', 'default_code', 
                                                'categ_id', 'product_brand_id',
                                                'list_price', 'standard_price'
                                            ]
                                        }
                                    )
                                    
                                    product_map = {p['id']: p for p in products}
                                    
                                    # Envanter verisini iÅŸle
                                    processed_inventory = []
                                    for item in inventory_data:
                                        product_id = item['product_id'][0] if item.get('product_id') else 0
                                        product_info = product_map.get(product_id, {})
                                        
                                        location = item.get('location_id')
                                        location_name = location[1] if isinstance(location, list) and len(location) > 1 else 'Bilinmeyen'
                                        
                                        product_name = item['product_id'][1] if isinstance(item.get('product_id'), list) and len(item['product_id']) > 1 else 'Bilinmeyen'
                                        
                                        categ = product_info.get('categ_id')
                                        category = categ[1] if isinstance(categ, list) and len(categ) > 1 else 'DiÄŸer'
                                        
                                        brand = product_info.get('product_brand_id')
                                        brand_name = brand[1] if isinstance(brand, list) and len(brand) > 1 else 'Bilinmeyen'
                                        
                                        processed_inventory.append({
                                            'product_id': product_id,  # Odoo unique ID - fatura kalemleri ile eÅŸleÅŸtirme iÃ§in
                                            'product_code': product_info.get('default_code', ''),
                                            'product_name': product_name,
                                            'category': category,
                                            'brand': brand_name,
                                            'location': location_name,
                                            'quantity': float(item.get('quantity', 0)),
                                            'reserved_quantity': float(item.get('reserved_quantity', 0)),
                                            'available_quantity': float(item.get('available_quantity', 0)),
                                            'list_price': float(product_info.get('list_price', 0)),
                                            'cost_price': float(product_info.get('standard_price', 0)),
                                            'total_value': float(item.get('quantity', 0)) * float(product_info.get('standard_price', 0))
                                        })
                                    
                                    # JSON dosyasÄ± oluÅŸtur
                                    inventory_json = {
                                        'inventory': processed_inventory,
                                        'total_records': len(processed_inventory),
                                        'total_quantity': sum(item['quantity'] for item in processed_inventory),
                                        'total_value': sum(item['total_value'] for item in processed_inventory),
                                        'last_update': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                                    }
                                    
                                    # SÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ dosya olarak kaydet (Level 9: Maksimum sÄ±kÄ±ÅŸtÄ±rma)
                                    with gzip.open('inventory.json.gz', 'wt', encoding='utf-8', compresslevel=9) as f:
                                        json.dump(inventory_json, f, ensure_ascii=False)
                                    
                                    file_size_mb = os.path.getsize('inventory.json.gz') / (1024 * 1024)
                                    print(f"âœ… inventory.json.gz oluÅŸturuldu: {file_size_mb:.2f} MB")
                                    print(f"ğŸ“Š Toplam miktar: {inventory_json['total_quantity']:,.0f}")
                                    print(f"ğŸ’° Toplam deÄŸer: ${inventory_json['total_value']:,.2f}")
                                    
                                else:
                                    print("âš ï¸ PerakendeStok filtresi bulunamadÄ±, envanter atlanÄ±yor...")
                                    
                            except Exception as e:
                                print(f"âš ï¸ Envanter Ã§ekme hatasÄ±: {e}")
                                print("âš ï¸ Envanter verisi atlanÄ±yor, fatura verileri ile devam ediliyor...")
                            
                            print("\n" + "=" * 60)
                            print("ğŸ‰ TÃœM VERÄ°LER BAÅARIYLA Ã‡EKÄ°LDÄ° VE Ä°ÅLENDÄ°!")
                            print("=" * 60)
                            
                        else:
                            print(f"âŒ Fatura verileri Ã§ekilemedi!")
                            print(f"YanÄ±t: {all_data if 'all_data' in locals() else 'Veri yok'}")
                            exit(1)
                        
                    else:
                        print("âŒ UID bulunamadÄ±!")
                        print(f"Session: {session_info}")
                        exit(1)
                else:
                    print("âŒ GeÃ§ersiz session!")
                    print(f"Result: {result}")
                    exit(1)
            else:
                print("âŒ Beklenmeyen yanÄ±t!")
                print(f"Response: {result}")
                exit(1)
                
        except Exception as e:
            print(f"âŒ Hata: {e}")
            import traceback
            traceback.print_exc()
            exit(1)
        
        EOF
    
    - name: Dosya BoyutlarÄ±nÄ± Kontrol Et
      run: |
        echo "ğŸ“Š OluÅŸturulan dosyalar:"
        ls -lh data-*.json.gz data-metadata.json 2>/dev/null || echo "âš ï¸ Dosyalar bulunamadÄ±"
        
        echo ""
        echo "ğŸ“Š Dosya boyutlarÄ±:"
        for file in data-*.json.gz; do
          if [ -f "$file" ]; then
            SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            SIZE_MB=$((SIZE / 1024 / 1024))
            echo "   - $file: ${SIZE_MB} MB"
            
            if [ $SIZE_MB -gt 100 ]; then
              echo "   âš ï¸ UYARI: $file 100 MB'dan bÃ¼yÃ¼k!"
            fi
          fi
        done
    
    - name: DeÄŸiÅŸiklikleri commit et ve yÃ¼kle
      env:
        PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        # DATA_MODE kaldÄ±rÄ±ldÄ± - kullanÄ±lmÄ±yor
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Eski data.json varsa sil (artÄ±k kullanmÄ±yoruz)
        if [[ -f "data.json" ]]; then
          echo "ğŸ—‘ï¸ Eski data.json siliniyor..."
          git rm -f data.json 2>/dev/null || rm -f data.json
        fi
        
        # Yeni dosyalarÄ± kontrol et
        if ls data-*.json.gz 1> /dev/null 2>&1; then
          echo "âœ… YÄ±llara bÃ¶lÃ¼nmÃ¼ÅŸ dosyalar bulundu"
          
          # Ã–nce remote deÄŸiÅŸiklikleri Ã§ek
          echo "ğŸ”„ Remote deÄŸiÅŸiklikler kontrol ediliyor..."
          git fetch origin
          
          # Binary dosyalar iÃ§in "ours" stratejisi kullan (yeni data her zaman doÄŸrudur)
          git config merge.ours.driver true
          echo "data-*.json.gz merge=ours" >> .gitattributes
          echo "*.gz merge=ours" >> .gitattributes
          
          # Pull yap (conflict olursa bizim versiyonu kullan)
          if git pull origin main --no-rebase -X ours; then
            echo "âœ… Pull baÅŸarÄ±lÄ±"
          else
            echo "âš ï¸ Pull conflict veya non-fast-forward, merge ile devam ediyor..."
            # Pull baÅŸarÄ±sÄ±z olursa (conflict veya non-fast-forward)
            # Ã–nce remote'un son halini merge et
            if git merge origin/main -X ours --no-edit; then
              echo "âœ… Merge baÅŸarÄ±lÄ±"
            else
              echo "âš ï¸ Merge baÅŸarÄ±sÄ±z, yeni data ile force merge..."
              # Merge de baÅŸarÄ±sÄ±z olursa (conflict)
              git checkout --ours data-*.json.gz data-metadata.json 2>/dev/null || true
              git add data-*.json.gz data-metadata.json .gitattributes 2>/dev/null || true
              # Merge'i tamamla (conflict Ã§Ã¶zÃ¼ldÃ¼)
              git merge --continue 2>/dev/null || git commit --no-edit 2>/dev/null || echo "Merge zaten tamamlanmÄ±ÅŸ"
            fi
          fi
          
          # YENÄ° DOSYALARI EKLE (eski dosyalar otomatik gÃ¼ncellenir)
          echo "âœ… Yeni data dosyalarÄ± ve metadata ekleniyor..."
          git add -f data-*.json.gz data-metadata.json 2>/dev/null || echo "âš ï¸ Data dosyalarÄ± bulunamadÄ±"
          
          # Envanter dosyasÄ± varsa ekle (her iki mode iÃ§in)
          if [[ -f "inventory.json.gz" ]]; then
            echo "ğŸ“¦ Envanter dosyasÄ± ekleniyor..."
            git add inventory.json.gz
          fi
          
          
          if [[ -n $(git status -s) ]]; then
            git commit -m "Veriler gÃ¼ncellendi (Fatura + Envanter) - $(date +'%Y-%m-%d %H:%M')" || echo "Zaten commit edilmiÅŸ"
            
            # Push URL'ini PAT ile gÃ¼ncelle
            git remote set-url origin https://x-access-token:${PAT_TOKEN}@github.com/toftamars/satiss-dashboard.git
            
            # Push et (non-fast-forward iÃ§in force-with-lease kullan)
            if git push origin main; then
              echo "âœ… DeÄŸiÅŸiklikler GitHub'a yÃ¼klendi!"
              echo "ğŸš€ Vercel otomatik deploy tetiklendi (GitHub commit'ine baÄŸlÄ±)"
              echo "   ğŸ“ Not: Query string cache busting aktif (v= versiyon parametresi)"
            else
              echo "âš ï¸ Normal push baÅŸarÄ±sÄ±z, force-with-lease deneniyor..."
              # Push baÅŸarÄ±sÄ±z olursa (non-fast-forward hatasÄ±)
              # force-with-lease gÃ¼venli force push (baÅŸka birisi push etmediyse)
              if git push origin main --force-with-lease; then
                echo "âœ… Force push (with lease) baÅŸarÄ±lÄ±!"
                echo "ğŸš€ Vercel otomatik deploy tetiklendi (GitHub commit'ine baÄŸlÄ±)"
                echo "   ğŸ“ Not: Query string cache busting aktif (v= versiyon parametresi)"
              else
                echo "âŒ Push baÅŸarÄ±sÄ±z - Remote'da yeni commit var, bir sonraki Ã§alÄ±ÅŸtÄ±rmada otomatik merge edilecek"
              exit 1
              fi
            fi
          else
            echo "â„¹ï¸ DeÄŸiÅŸiklik yok"
          fi
        else
          echo "âš ï¸ data.json dosyasÄ± bulunamadÄ±"
        fi
